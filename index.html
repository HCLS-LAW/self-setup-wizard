<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Self-Setup Wizard ðŸ§™</title>
  <!-- Brand Typography -->
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root{ --content-pad:24px }
    /* ========================
       HCLS Brand Theme (v2)
       ======================== */
    :root{
      /* Brand palette (primary maroon derived from prior HCLS assets) */
      --brand-700:#42030F; /* HCLS maroon */
      --brand-600:#6A1A28; /* lighter maroon */
      --brand-500:#A12B3D; /* accent */
      --brand-300:#E3C7C9; /* soft tint */

      --bg:#FFFFFF; --text:#121212; --muted:#6b7280; --border:#e5e7eb; --surface:#FAF7F6;
      --card:#FFFFFF; --shadow:0 6px 28px rgba(18,18,18,.08);
      --focus:0 0 0 3px rgba(161,43,61,.25);
      --border-light: color-mix(in srgb, var(--border), var(--bg) 40%);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0C0B0C; --text:#F5F5F5; --muted:#A3A3A3; --border:#26272B; --surface:#121214; --card:#121214; --shadow:0 8px 30px rgba(0,0,0,.35);
      }
    }

    /* Explicit theme overrides. Default to light for readability. */
    [data-theme="light"]{
      --bg:#FFFFFF; --text:#111827; --muted:#6B7280; --border:#E5E7EB; --surface:#F8FAFC; --card:#FFFFFF; --shadow:0 6px 28px rgba(17,24,39,.08);
    }
    [data-theme="dark"]{
      --bg:#111214; --text:#FAFAFA; --muted:#C2C7D0; --border:#3A3E46; --surface:#181A1F; --card:#1F2229; --shadow:0 8px 30px rgba(0,0,0,.55);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background: radial-gradient(1100px 600px at 90% -20%, rgba(161,43,61,.35), transparent 60%), linear-gradient(120deg, var(--brand-700), var(--brand-600) 55%, var(--brand-500)); color:var(--text); font-family:'EB Garamond', serif; font-size:16px;}
    .band, .main{position:relative; z-index:1}

    /* Animated background blobs */
    .bg{position:fixed; inset:0; z-index:0; overflow:hidden; pointer-events:none}
    .bg .blob{position:absolute; width:60vmax; height:60vmax; border-radius:50%; filter:blur(60px); opacity:.55; will-change:transform; transform:translateZ(0)}
    .bg .b1{left:-10vmax; top:-10vmax; background:radial-gradient(circle at 30% 30%, var(--brand-500), transparent 60%); animation:blob1 48s cubic-bezier(.6,0,.4,1) infinite; animation-delay:-4s}
    .bg .b2{right:-8vmax; top:-6vmax; background:radial-gradient(circle at 70% 30%, var(--brand-700), transparent 60%); animation:blob2 56s cubic-bezier(.6,0,.4,1) infinite; animation-delay:-12s}
    .bg .b3{left:-12vmax; bottom:-10vmax; background:radial-gradient(circle at 40% 70%, var(--brand-600), transparent 60%); animation:blob3 54s cubic-bezier(.6,0,.4,1) infinite; animation-delay:-18s}
    .bg .b4{right:-14vmax; bottom:-12vmax; background:radial-gradient(circle at 60% 60%, var(--brand-400), transparent 60%); animation:blob4 62s cubic-bezier(.6,0,.4,1) infinite; animation-delay:-8s}
    /* Gold accent blobs */
    .bg .g1{left:10vmax; top:15vmax; width:32vmax; height:32vmax; background:radial-gradient(circle at 45% 40%, #fff8bb 0%, #f7e796 18%, #CBB26A 40%, rgba(203,178,106,.6) 60%, transparent 72%); filter:blur(24px); opacity:.70; mix-blend-mode:screen; animation:gold1 22s ease-in-out infinite alternate}
    .bg .g2{right:18vmax; top:28vmax; width:28vmax; height:28vmax; background:radial-gradient(circle at 55% 50%, #fff6a8 0%, #efd577 18%, #be9e44 42%, rgba(190,158,68,.55) 62%, transparent 74%); filter:blur(26px); opacity:.65; mix-blend-mode:screen; animation:gold2 30s ease-in-out infinite alternate}
    .bg .g3{left:35vmax; bottom:14vmax; width:30vmax; height:30vmax; background:radial-gradient(circle at 50% 60%, #fff7b3 0%, #eadc92 18%, #d8c690 40%, rgba(216,198,144,.5) 60%, transparent 72%); filter:blur(22px); opacity:.60; mix-blend-mode:screen; animation:gold3 26s ease-in-out infinite alternate}

    @keyframes blob1{
      0%{transform:translate(0,0) scale(1) rotate(0deg)}
      25%{transform:translate(12vmax,6vmax) scale(1.08) rotate(8deg)}
      50%{transform:translate(20vmax,-2vmax) scale(0.98) rotate(0deg)}
      75%{transform:translate(10vmax,-10vmax) scale(1.1) rotate(-6deg)}
      100%{transform:translate(0,0) scale(1) rotate(0deg)}
    }
    @keyframes blob2{
      0%{transform:translate(0,0) scale(1.05) rotate(0deg)}
      20%{transform:translate(-8vmax,8vmax) scale(1) rotate(-6deg)}
      50%{transform:translate(-16vmax,18vmax) scale(0.96) rotate(0deg)}
      80%{transform:translate(-6vmax,22vmax) scale(1.06) rotate(6deg)}
      100%{transform:translate(0,0) scale(1.05) rotate(0deg)}
    }
    @keyframes blob3{
      0%{transform:translate(0,0) scale(0.96) rotate(0deg)}
      30%{transform:translate(10vmax,-6vmax) scale(1.05) rotate(6deg)}
      60%{transform:translate(22vmax,-10vmax) scale(1.1) rotate(-4deg)}
      85%{transform:translate(14vmax,0vmax) scale(0.98) rotate(0deg)}
      100%{transform:translate(0,0) scale(0.96) rotate(0deg)}
    }
    @keyframes blob4{
      0%{transform:translate(0,0) scale(1) rotate(0deg)}
      25%{transform:translate(-10vmax,-6vmax) scale(1.02) rotate(-6deg)}
      55%{transform:translate(-20vmax,-14vmax) scale(1.06) rotate(4deg)}
      85%{transform:translate(-10vmax,-2vmax) scale(1.02) rotate(0deg)}
      100%{transform:translate(0,0) scale(1) rotate(0deg)}
    }
    @keyframes gold1{
      0%{transform:translate(0,0) scale(1) rotate(0deg)}
      25%{transform:translate(6vmax,-4vmax) scale(1.06) rotate(4deg)}
      50%{transform:translate(10vmax,2vmax) scale(1.02) rotate(0deg)}
      75%{transform:translate(4vmax,6vmax) scale(1.08) rotate(-3deg)}
      100%{transform:translate(0,0) scale(1) rotate(0deg)}
    }
    @keyframes gold2{
      0%{transform:translate(0,0) scale(1)}
      30%{transform:translate(-8vmax,4vmax) scale(0.98)}
      60%{transform:translate(-10vmax,10vmax) scale(1.05)}
      100%{transform:translate(0,0) scale(1)}
    }
    @keyframes gold3{
      0%{transform:translate(0,0) scale(0.98)}
      35%{transform:translate(6vmax,6vmax) scale(1.06)}
      70%{transform:translate(12vmax,2vmax) scale(1.02)}
      100%{transform:translate(0,0) scale(0.98)}
    }

    @keyframes hcls-shake{
      0%{transform:translateX(0)}
      15%{transform:translateX(-8px)}
      30%{transform:translateX(8px)}
      45%{transform:translateX(-6px)}
      60%{transform:translateX(6px)}
      75%{transform:translateX(-3px)}
      90%{transform:translateX(3px)}
      100%{transform:translateX(0)}
    }
    .shake{animation:hcls-shake .45s ease-in-out 1}
    @media (prefers-reduced-motion: reduce){ .shake{animation:none} }

    @media (prefers-reduced-motion: reduce){
      .bg .blob{animation:none}
    }

    /* Header band overlays global background (no separate background to avoid seams) */
    .band{ background:transparent; color:#fff; padding:28px 0 24px; position:relative }
    .band .container{position:relative}
    .title{margin:0; letter-spacing:.2px; font-weight:700; font-size:28px}
    .subtitle{margin-top:6px; opacity:.85; font-size:15px}

    .container{max-width:1120px; margin:0 auto; padding:0 16px; background:transparent}

    /* Controls */
    .controls{display:flex; gap:10px; align-items:center}
    .btn{border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.12); color:#fff; padding:9px 12px; border-radius:12px; cursor:pointer; font-size:14px; backdrop-filter: blur(4px);}
    .btn:hover{background:rgba(255,255,255,.18)}
    .btn:focus{outline:none; box-shadow:var(--focus)}
    /* Button press micro delay */
    .btn, .btn-ghost, .btn-brand{transition:transform .08s ease}
    .btn:active, .btn-ghost:active, .btn-brand:active{transform:scale(.98)}

    /* Removed role/theme toggles */

    /* Main layout */
    .main{padding:24px 0 40px; background:transparent}
    .row{display:flex; gap:24px; align-items:flex-start}
    .left{width:300px; position:sticky; top:16px; align-self:flex-start; z-index:60}
    .right{flex:1}

    .kpi{border:1px solid var(--border); background:var(--card); border-radius:16px; padding:18px; box-shadow:var(--shadow); backdrop-filter: blur(2px)}
    .kpi .label{display:flex; justify-content:space-between; font-size:14px; color:var(--muted); margin-bottom:8px}
    .progress{height:10px; background:var(--surface); border:1px solid var(--border); border-radius:999px; overflow:hidden}
    .bar{height:100%; background:linear-gradient(90deg, var(--brand-600), var(--brand-500)); width:0; transition:width .25s ease}
    /* Progress shimmer on increase */
    .progress{position:relative}
    .bar{position:relative}
    .bar.shimmer::after{content:""; position:absolute; inset:0; background:linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent); transform:translateX(-100%); animation:sh .6s ease}
    @keyframes sh{to{transform:translateX(100%)}}

    /* Sidebar */
    .sidebar{display:flex; flex-direction:column; gap:10px; border:1px solid var(--border); background:var(--card); border-radius:16px; padding:12px; box-shadow:var(--shadow); max-height:calc(100vh - 240px); overflow:auto; -ms-overflow-style:none; scrollbar-width:none; scroll-behavior:smooth; position:relative; z-index:61}
    .sidebar::-webkit-scrollbar{width:0; height:0}
    .step{border:1px solid var(--border-light); border-radius:16px; background:var(--surface); padding:16px 18px; text-align:left; cursor:pointer; box-shadow:var(--shadow); position:relative; backdrop-filter: blur(2px)}
    .step:hover{transform:translateY(-1px);}
    .step:focus-visible{outline:2px solid var(--brand-400); outline-offset:2px}
    .step.active{border-color:var(--brand-500); box-shadow:0 0 0 2px rgba(161,43,61,.15)}
    .step.active::before{content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background:linear-gradient(180deg, var(--brand-600), var(--brand-400))}
    .step .title{font-size:15px; font-weight:650}
    .step .tag{font-size:12px; color:var(--brand-600); background:linear-gradient(120deg, var(--brand-300), #fff); border:1px solid var(--border); padding:2px 8px; border-radius:999px; display:inline-block; margin-top:6px}
    .step .count{font-size:12px; color:var(--muted); white-space:nowrap}
    .step.disabled{opacity:.6}
    .status-icon{position:absolute; right:10px; bottom:10px; width:16px; height:16px}
    .status-icon svg{width:16px; height:16px; display:block}

    /* Firm logo (fixed bottom-left) */
    .firm-logo{position:fixed; left:calc(var(--content-pad) - 4px); bottom:calc(var(--content-pad) - 4px); width:180px; max-width:21vw; height:auto; z-index:50; opacity:.96; user-select:none}

    /* Content card */
    .content{border:1px solid var(--border); background:var(--card); border-radius:18px; padding:var(--content-pad); box-shadow:var(--shadow); backdrop-filter: blur(2px)}
    .content h2{margin:0; font-size:22px}
    /* Step title reveal */
    @keyframes titleIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)}}
    .content h2.reveal{animation:titleIn .28s ease}
    .content p{margin:8px 0 16px; line-height:1.6; font-size:16px}
    .content ul{margin:8px 0 16px 22px; font-size:16px}
    .content li{margin:6px 0}
    .divider{height:1px; background:var(--border); margin:16px 0}
    /* Divider draw */
    @keyframes drawLine{from{transform:scaleX(0)} to{transform:scaleX(1)}}
    .divider.reveal{transform-origin:left; transform:scaleX(0); animation:drawLine .35s ease forwards}
    /* Card entrance stagger */
    @keyframes cardIn{from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:translateY(0)}}
    .content .kpi{opacity:0; animation:cardIn .25s ease forwards; animation-delay:calc(var(--i, 0) * 60ms)}
    /* Checklist micro-pop */
    @keyframes microPop{50%{transform:scale(1.03)} 100%{transform:scale(1)}}
    #tasksList span{display:inline-block}
    #tasksList .pop{animation:microPop .18s ease}
    
    /* Add breathing room between information blocks within the main content */
    .content .kpi{margin:12px 0}
    .content .kpi:first-child{margin-top:0}
    .content .kpi:last-child{margin-bottom:0}
    /* Normalize card backgrounds: info cards white; checklist cards light blue */
    .content .kpi{background:var(--card) !important}
    .content .kpi.checklist-card{background:var(--surface) !important}
    /* Save flash */
    @keyframes flash{0%,100%{filter:none} 50%{filter:drop-shadow(0 0 6px rgba(103,232,249,.6))}}
    .save.flash{animation:flash .6s ease}
    /* Subtle pulse on active step */
    @keyframes subtlePulse{0%,100%{box-shadow:0 0 0 0 rgba(161,43,61,0)} 50%{box-shadow:0 0 0 2px rgba(161,43,61,.08)}}
    .step.active{animation:subtlePulse 2.5s ease-in-out infinite}
    /* Mini confetti removed per UX update */
    /* Link underline slide */
    .content a{position:relative; text-decoration:none; color:#2a6496}
    .content a::after{content:""; position:absolute; left:0; right:0; bottom:-2px; height:2px; background:currentColor; transform:scaleX(0); transform-origin:left; transition:transform .2s ease}
    .content a:hover::after{transform:scaleX(1)}
    /* Toasts */
    #toastRoot{position:fixed; top:16px; right:16px; z-index:10001; display:flex; flex-direction:column; gap:8px; pointer-events:none}
    .toast{pointer-events:auto; border:1px solid var(--border); background:var(--card); color:var(--text); padding:10px 12px; border-radius:10px; box-shadow:var(--shadow); font-size:14px; opacity:0; transform:translateY(-6px); animation:toastIn .25s ease forwards}
    @keyframes toastIn{to{opacity:1; transform:translateY(0)}}
    @keyframes toastOut{to{opacity:0; transform:translateY(-6px)}}

    .btn-ghost{border:1px solid var(--border); background:var(--card); color:var(--text); padding:9px 12px; border-radius:12px; cursor:pointer; font-size:16px; box-shadow:0 1px 2px rgba(0,0,0,.08); transition:box-shadow .2s, filter .2s}
    .btn-ghost:hover{background:var(--surface); box-shadow:0 2px 4px rgba(0,0,0,.12)}

    .btn-brand{border:0; background:linear-gradient(135deg, var(--brand-600), var(--brand-500)); color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; font-size:16px; box-shadow:0 1px 2px rgba(0,0,0,.16); transition:box-shadow .2s, filter .2s}
    .btn-brand:hover{filter:brightness(1.05); box-shadow:0 2px 6px rgba(0,0,0,.2)}

    .input{width:100%; border:1px solid var(--border-light); border-radius:10px; padding:10px 12px; font-family:'Inter', sans-serif; font-size:16px; background:var(--card); color:var(--text)}
    textarea.input{min-height:260px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px}
    .signature-box{width:100%; border:1px solid var(--border-light); border-radius:10px; height:44px; background:var(--card)}
    .error-banner{margin:12px 0 0; padding:10px 12px; border:1px solid rgba(161,43,61,.45); background:rgba(161,43,61,.08); color:#7a1a28; border-radius:10px; font-size:14px}
    @keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
    .shake{animation:shake .4s ease}
    .field-error{margin-top:6px; font-size:12px; color:#7a1a28}
    #finalChecklist{list-style:none; padding-left:0; margin-left:0}

    .save{display:flex; align-items:center; gap:8px; font-size:12px; color:#fff}
    .dot{width:8px; height:8px; border-radius:50%}
    .dot.saving{background:#ffd166; animation:pulse 1s infinite ease-in-out}
    .dot.saved{background:#67e8f9}
    @keyframes pulse{0%,100%{opacity:.35}50%{opacity:1}}

    /* Celebration step */
    .celebrate{position:relative; overflow:hidden; padding:40px 0; text-align:center}
    .celebrate h3{margin:0 0 12px; font-size:24px; animation:pop .6s ease-out}
    .celebrate p{margin:0; font-size:18px}
    .confetti-piece{position:absolute; width:8px; height:8px; top:-10px; animation:confetti 3s linear forwards; opacity:.9}
    @keyframes confetti{to{transform:translateY(180px) rotate(720deg); opacity:0}}
    @keyframes pop{from{transform:scale(.8); opacity:0} to{transform:scale(1); opacity:1}}



    @media (max-width: 980px){ .row{flex-direction:column} .left{width:100%; position:static} .sidebar{max-height:none} .firm-logo{left:12px; bottom:12px; width:105px; max-width:30vw} }

    /* Print */
    @media print{
      .band, #sidebar, #backBtn, #nextBtn, #resetBtn, #printBtn, #finalPrintBtn, #finishBtn { display:none !important; }
      .left{display:none}
      .right{width:100%}
      body{background:#fff; color:#000}
      .content{box-shadow:none; border-color:#ddd}
      /* Ensure animated elements render in print */
      .content .kpi{opacity:1 !important; animation:none !important; transform:none !important}
      .content h2.reveal{opacity:1 !important; animation:none !important; transform:none !important}
      .divider.reveal{transform:none !important; animation:none !important}
      .step.active{animation:none !important}
      .bar.shimmer::after{display:none !important}
      #toastRoot{display:none !important}
      /* Only the grey divider should trigger a new page */
      .print-break-before{break-before:auto; page-break-before:auto}
      .divider.print-break-before{break-before:page; page-break-before:always}
      .signature-hint{display:none !important}
      .firm-logo{display:none !important}
      .bg{display:none !important}
      /* Ensure signature box mirrors input field width/height when printing */
      .signature-box{display:block !important; width:100% !important; height:44px !important; border-radius:10px !important}

      /* Print-friendly checklist indicators */
      #finalChecklist li{position:relative; padding-left:22px; margin:6px 0}
      #finalChecklist li::before{content:"â˜"; position:absolute; left:0; top:0; font-size:14px; line-height:1}
      #finalChecklist li.done::before{content:"â˜‘"}
      /* Hide colored dot in print to avoid ambiguity */
      #finalChecklist li > span{display:none !important}
    }

    /* Fullscreen landing overlay */
    .landing{position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center; background:radial-gradient(1100px 600px at 90% -20%, rgba(161,43,61,.35), transparent 60%), linear-gradient(120deg, var(--brand-700), var(--brand-600) 55%, var(--brand-500)); color:#fff;}
    .landing.hidden{opacity:0; pointer-events:none; transition:opacity .6s ease}
    .landing .panel{max-width:720px; width:92%; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.25); border-radius:20px; padding:28px; box-shadow:0 20px 60px rgba(0,0,0,.35); backdrop-filter: blur(6px)}
    .landing h1{margin:0 0 8px; font-size:34px; letter-spacing:.2px}
    .landing p{margin:8px 0 16px; opacity:.92}
    .landing .row{gap:12px}
    .landing .input{background:rgba(255,255,255,.12); color:#fff; border-color:rgba(255,255,255,.35)}
    .landing .btn-brand{background:#fff; color:var(--brand-700)}
    .welcome{margin-top:10px; font-size:16px; opacity:.95}
    .spinner{display:inline-block; width:16px; height:16px; border:2px solid rgba(255,255,255,.45); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite; vertical-align:middle; margin-left:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Generic fade-in helper used for closing overlay */
    .fade-in{opacity:0; transition:opacity .6s ease}
    .fade-in.show{opacity:1}
    .closing-overlay .panel{max-width:720px}
    .admin-overlay{align-items:flex-start; padding:24px 16px; overflow:auto}
    .admin-overlay .panel{max-width:1000px; width:96%; max-height:calc(100vh - 48px); overflow:auto}
  </style>
</head>
<body>
  <!-- Brand header band -->
  
  <div class="band">
    <div class="container" style="display:flex; justify-content:space-between; align-items:flex-start; gap:16px">
      <div>
        <h1 class="title">Self-Setup Wizard ðŸ§™</h1>
      </div>
      <div class="controls">
        <div id="saveState" class="save"><span class="dot saved" id="saveDot"></span><span id="saveText">Saved</span></div>
        <button class="btn" id="resetBtn" title="Clear progress">Reset</button>
      </div>
    </div>
  </div>

  <!-- Landing overlay (Stage 0 aesthetic layer) -->
  <div id="landing" class="landing">
    <div class="panel">
      <h1>Welcome to HCLS</h1>
      <p>Please enter your Unique ID for a personalized setup.</p>
      <div class="row">
        <input class="input" id="landingUid" placeholder="Unique ID" aria-label="Unique ID" style="flex:1">
        <button class="btn-brand" id="landingApply">Continue</button>
      </div>
      <div id="landingMsg" class="welcome" aria-live="polite"></div>
    </div>
  </div>

  <!-- Animated background layer -->
  <div class="bg" aria-hidden="true">
    <div class="blob b1"></div>
    <div class="blob b2"></div>
    <div class="blob b3"></div>
    <div class="blob b4"></div>
    <div class="blob g1"></div>
    <div class="blob g2"></div>
    <div class="blob g3"></div>
  </div>

  <div class="main">
    <div class="container">
      <a href="https://hc-ls.ca/member-onboarding" target="_blank" rel="noopener" aria-label="Go to HCLS Member Onboarding">
        <img id="firmLogo" class="firm-logo" alt="HCLS Logo" src="https://i.imghippo.com/files/SdSc7795mI.png" />
      </a>
      <div id="toastRoot" aria-live="polite" aria-atomic="true"></div>
      <section class="kpi">
        <div class="label">
          <span>Overall completion</span>
          <span id="pct">0%</span>
        </div>
        <div class="progress"><div class="bar" id="bar"></div></div>
      </section>

      <section class="row" style="margin-top:24px">
        <aside class="left">
          <nav id="sidebar" class="sidebar" aria-label="Steps"></nav>
        </aside>
        <main class="right">
          <div class="content">
            <h2 id="stepTitle">&nbsp;</h2>
            <div id="stepBody" style="margin-top:16px"></div>

            <div id="tasksWrap" style="margin-top:12px; display:none">
              <div style="font-size:15px; font-weight:650; margin-bottom:6px">Mark as completed</div>
              <div class="kpi checklist-card" style="padding:12px" id="tasksList"></div>
            </div>

            <div class="row" style="justify-content:space-between; margin-top:16px">
              <button class="btn-ghost" id="backBtn">Back</button>
              <button class="btn-brand" id="nextBtn">Next</button>
            </div>
          </div>
        </main>
      </section>

    </div>
  </div>

  <script>
  (function(){
    const STORAGE_KEY = 'hcls_onboarding_html_v2';
    const SCHEMA_VERSION = 3;
    const PRESETS_KEY = 'hcls_onboarding_presets_v2';
    const slug = (s)=> s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)+/g,'');
    // Declarative requirements by step title slug
    const stepRequirements = {
      'getting-started-as-an-hcls-network-member': { requiredInputs: [] },
      'profile-role': { requiredInputs: ['fullName','title','workEmail','etransferEmail'] },
      'setting-up-your-computer': { requiredTasks: ['Created Separate Work Profile on Computer'] },
      'setting-up-your-outlook-email-calendar': { requiredTasks: ['Installed and logged into Outlook','Installed and logged into Clio Outlook add-in','Updated availabilities in Outlook calendar'] },
      'setting-up-your-clio-manage-account': { requiredTasks: ['Logged into Clio Manage & Updated password','Installed and logged into Clio Drive / Desktop launcher','Registered for Clio Manage training'] },
      'clio-manage-task-list': { requiredInputs: [] },
      'clio-mobile-app': { requiredTasks: ['Installed and logged into Clio mobile app'] },
      'lexis-account': { requiredTasks: ['Logged into Lexis+'] },
      'setting-up-your-zoom-account': { requiredTasks: ['Installed and logged into Zoom app'] },
      'setting-up-your-chatgpt-account': { requiredTasks: ['Installed ChatGPT Application','I acknowledge the HCLS Best Practices for AI tools','I will cross-reference AI outputs with sources','I will reread AI-generated text to ensure intent is maintained'] },
      'adobe-acrobat-pro-account': { requiredTasks: ['Logged into Adobe Acrobat Pro','Downloaded Adobe Acrobat Pro to desktop'] },
      'reviewing-clio-matters': { requiredInputs: [] },
      'setting-up-your-clio-grow-account': { requiredTasks: ['Logged into Clio Grow account','Registered for Clio Grow training'] },
      'jso-caselines-lao-portals': { requiredTasks: [
        { id:'jso-cred-saved', text:'I have saved my login credentials in the "Master Password List for Contractors" for LAO, JSO, and CaseLines' },
        { id:'jso-cred-update', text:'I will update my login credentials should I be prompted to change them in the future' }
      ] },
      // Removed stale keys for optional sections after title updates
      'security-confidentiality-guidelines': { requiredTasks: ['I will use a password manager to store credentials','I will keep client communications professional and secure','I will not discuss case details outside authorized channels','I will not store sensitive information in AI tools'] },
      'hst-registration': { requiredTasks: [
        { id:'hst-gather', text:'I gathered required personal/corporate details and effective date' },
        { id:'hst-register', text:'I registered for BN and GST/HST (BRO or RC1)' },
        { id:'hst-effective-date', text:'I selected appropriate effective date' },
        { id:'hst-record', text:'I recorded BN and GST/HST account number' },
        { id:'hst-obligations', text:'I understand that I must charge/collect/file/remit my financial obligations' },
        { id:'hst-quick-method', text:'I reviewed the Quick Method and ITCs considerations' },
        { id:'hst-disclaimer', text:'I understand that HCLS is not providing me with financial or taxation advice, and that the above guide is for informational purposes only' }
      ] },
      'member-portal': { requiredTasks: [
        { id:'mp-account', text:'I created an account on the Firm website and requested Member Portal access' },
        { id:'mp-bookmark', text:'I bookmarked the Member Portal' },
        { id:'mp-invoices', text:'I understand that invoices can be generated via the Member Portal' },
        { id:'mp-training', text:'I noted the training video password: HCLS_Training' }
      ] },
      'completion-checklist-acknowledgment': { requiredInputs: ['etransferEmail'] }
    };

    // Role-aware steps (role: 'all' | 'lawyer' | 'student')
    const stepsData = [
      { role:'all', title: 'Unique ID (Auto Fill)', content: `
        <p>Enter your HCLS Unique ID to auto-fill your profile, email, title, extension, and passwords in this walkthrough.</p>
        <div class="row" style="gap:12px">
          <div style="flex:1">
            <label style="font-size:15px; font-weight:650">Unique ID</label>
            <input class="input" data-field="uniqueId" placeholder="e.g., AWOL" aria-label="Unique ID">
          </div>
          <div style="align-self:flex-end">
            <button class="btn-brand" id="applyUniqueBtn">Apply</button>
          </div>
        </div>
            <p style="font-size:13px; color:var(--muted); margin-top:6px">Test IDs: <code>92501I</code></p>
      `},
      { role:'all', title: 'Getting Started as an HCLS Network Member', content: `
        <p>During your first week, you should focus on:</p>
        <ul>
          <li>Signing into / setting up your accounts and your devices.</li>
          <li>Completing Clio training and familiarizing yourself with Platform workflows.</li>
          <li>Reviewing assigned cases and tasks.</li>
        </ul>
      `},
        { role:'all', title: 'Profile & Role', content: `
          <div class="row" style="gap:12px">
            <div style="flex:1">
              <label style="font-size:15px; font-weight:650">Full name</label>
              <input class="input" data-field="fullName" placeholder="Jane Doe" aria-label="Full name" readonly>
            </div>
            <div style="flex:1">
              <label style="font-size:15px; font-weight:650">Title</label>
              <input class="input" data-field="title" aria-label="Title" readonly>
            </div>
          </div>
          <div class="row" style="gap:12px; margin-top:8px">
            <div style="flex:1">
              <label style="font-size:15px; font-weight:650">Accreditations</label>
              <input class="input" data-field="credentials" placeholder="JD, LLM" aria-label="Accreditations">
            </div>
            <div style="flex:1">
              <label style="font-size:15px; font-weight:650">Phone extension</label>
              <input class="input" data-field="phoneExt" placeholder="100" aria-label="Phone extension" readonly>
            </div>
          </div>
          <div class="row" style="gap:12px; margin-top:8px">
            <div style="flex:1">
              <label style="font-size:15px; font-weight:650">Work email</label>
              <input class="input" data-field="workEmail" type="email" placeholder="j.smith@hcls.law" aria-label="Work email" readonly>
            </div>
            <div style="flex:1">
              <label style="font-size:15px; font-weight:650">E-transfer email</label>
              <input class="input" data-field="etransferEmail" placeholder="name@example.com" aria-label="E-transfer email">
            </div>
          </div>
      `},
      { role:'all', title: 'Setting Up Your Computer', content: `
        <p>Create a new work profile on your computer to separate your personal contents from client / work contents.</p>
        <ul>
          <li><a href="https://support.apple.com/en-ca/guide/mac-help/mchl3e281fc9/mac" target="_blank" rel="noopener noreferrer">For Apple computers</a></li>
          <li><a href="https://support.microsoft.com/en-us/windows/manage-user-accounts-in-windows-104dc19f-6430-4b49-6a2b-e4dbd1dcdf32" target="_blank" rel="noopener noreferrer">For Windows computers</a></li>
        </ul>
        <p>After creating a new profile, log out of your personal profile and log in to your new work profile. All following steps are to be done in your new work profile.</p>
        <ul>
          <li><a href="https://www.microsoft.com/en-us/microsoft-365/download-office#download" target="_blank" rel="noopener noreferrer">Download Microsoft Office</a></li>
        </ul>
      `, tasks: ['Created Separate Work Profile on Computer','Downloaded Microsoft Office','I am currently signed in on my computer\'s "Work Profile"'] },
      { role:'all', title: 'Setting Up Your Outlook Email & Calendar', content: `
        <p>Log in to your HCLS Outlook account to access your emails and calendar.</p>
        <p>It is strongly recommended to use the Outlook App for the best experience and not the web browser version.</p>
        <div class="kpi" style="padding:12px; background:var(--surface)">
          <div style="font-weight:650; margin-bottom:6px">Credentials</div>
          <div class="row" style="gap:12px">
            <div style="flex:1">
              <label style="font-size:15px; font-weight:650">Your email</label>
              <input class="input" data-field="workEmail" placeholder="j.smith@hcls.law" aria-label="Your HCLS work email" readonly>
            </div>
            <div style="flex:1">
              <label style="font-size:15px; font-weight:650">Password</label>
              <p style="margin:8px 0 0; font-size:15px">Master password can be found in your onboarding package. Please update all passwords after logging in.</p>
            </div>
          </div>
        </div>
        <ul>
          <li><a href="https://appsource.microsoft.com/en-us/product/office/WA200003566?tab=Overview" target="_blank" rel="noopener noreferrer">Download the Clio Outlook add-in (Desktop)</a></li>
        </ul>
        <p>The Outlook Calendar is the primary tool for viewing scheduled work during the week and for Network Members to check each other's availabilities.</p>
        <p>Please block off any days or times when you are or intend to be unavailable (e.g., weekends, holidays, appointments, and general time off).</p>
        <p>You are responsible for populating and maintaining your Outlook Calendar with your tasks, meetings, Court appearances, and deadlines so that it accurately reflects your availability.</p>
        <p>Make sure to make your Outlook Calendar visible to other Network Members so that they can check your availabilities (either "Can view titles and locations" or "Can view all details"). <a href="https://support.microsoft.com/en-us/office/share-an-outlook-calendar-as-view-only-with-others-353ed2c1-3ec5-449d-8c73-6931a0adab88" target="_blank" rel="noopener noreferrer">How to share your Outlook calendar</a>.</p>
        <h3 style="margin:10px 0 6px">Outlook Font & Email Signature Settings</h3>
        <p>In your <a href="https://support.microsoft.com/en-us/office/change-the-default-font-or-text-color-for-email-messages-in-outlook-1aabb236-01d4-4faf-b998-a4087da3ceab" target="_blank" rel="noopener noreferrer">Outlook settings</a>, ensure the following is set:</p>
        <ul style="margin:6px 0 10px 22px; list-style:disc;">
          <li>Font: EB Garamond</li>
          <li>Size: 12</li>
        </ul>
        <p>Copy/paste the below signature block into your <a href="https://support.microsoft.com/en-us/office/change-an-email-signature-86597769-e4df-4320-b219-39d6e1a9e87b" target="_blank" rel="noopener noreferrer">Outlook's settings</a> for all outgoing emails.</p>
        <p style="font-style:italic">Optional: You can edit your name in the email signature directly in Outlook when pasting the block should you want to make any changes (e.g., using initials for a middle name or removing it entirely).</p>
        <div class="kpi" style="padding:12px; background:var(--surface)">
          <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px">
            <div style="font-weight:650">Email Signature</div>
            <button class="btn-ghost" id="copyOutlookSigBtn" title="Copy signature to clipboard">Copy Signature</button>
          </div>
          <div id="outlookSignaturePreview" style="background:#fff; border:1px solid var(--border); border-radius:10px; padding:14px; font-size:12pt"></div>
        </div>
      `, tasks: ['Installed and logged into Outlook','Installed and logged into Clio Outlook add-in','Updated availabilities in Outlook calendar','Shared Outlook calendar visibility'] },
      { role:'all', title: 'Member Portal', content: `
        <div class="kpi" style="padding:16px">
          <h3 style="margin:0 0 8px">Account & Access</h3>
          <ul>
            <li><a href="https://hc-ls.ca/m/login" target="_blank" rel="noopener noreferrer">Sign into</a> your Member Portal on the Firm's website.</li>
            <li>Use your Firmâ€‘provided email address.</li>
          </ul>
           <div class="divider"></div>
          <h3 style="margin:0 0 8px">Accessing the Member Portal</h3>
          <ul>
            <li>HCLS offers a hub of useful links, guides, and tools to facilitate onboarding and ongoing work via the <a href="https://hc-ls.ca/member-portal" target="_blank" rel="noopener noreferrer">Member Portal</a>.</li>
            <li>The Member Portal is your primary reference point and should be bookmarked.</li>
            <li>Generating invoices for payment is facilitated via the Member Portal.</li>
          </ul>
          <div class="divider"></div>
          <h3 style="margin:0 0 8px">Training Videos</h3>
          <ul>
            <li>There are several training/reference videos available on the Member Portal.</li>
            <li>Password to view these videos: <code>HCLS_Training</code></li>
          </ul>
        </div>
      `, tasks: [
        { id:'mp-account', text:'I created an account on the Firm website and requested Member Portal access' },
        { id:'mp-bookmark', text:'I bookmarked the Member Portal' },
        { id:'mp-invoices', text:'I understand that invoices can be generated via the Member Portal' },
        { id:'mp-training', text:'I noted the training video password: HCLS_Training' }
      ] },
      { role:'all', title: 'Setting Up Your Clio Manage Account', content: `
        <p><a href="https://account.clio.com/" target="_blank" rel="noopener noreferrer">Log in to your Clio Manage Account</a></p>
        <ul>
          <li>If you are prompted to select a server, choose "United States/Mexico".</li>
          <li>Use your HCLS email</li>
          <li>Change your password once you've logged in for the first time and setup two factor authentication.</li>
        </ul>
        <p><a href="https://help.clio.com/hc/en-us/articles/9031393962395-Set-Up-Clio-Drive" target="_blank" rel="noopener noreferrer">Download Clio Drive / Desktop Launcher</a></p>
        <p>Look around the Clio web app and get a feel for it.</p>
        <p><a href="https://help.clio.com/hc/en-us/articles/9290390462875-Navigate-Clio-Manage" target="_blank" rel="noopener noreferrer">Review the Clio Help Center guide to better understand how the system works.</a></p>
        <p><a href="https://www.clio.com/resources/quick-start-sessions/start-using-clio-manage-today/" target="_blank" rel="noopener noreferrer">Register for a 30-minute training session on how to use Clio Manage.</a></p>
        <p><a href="https://help.clio.com/hc/en-us/sections/29657344188187-Clio-Duo" target="_blank" rel="noopener noreferrer">Review the Clio Duo guide to better understand how to use this AI agent.</a></p>
        <p><a href="https://help.clio.com/hc/en-us/articles/9289960611355-Calendar-Sync-and-Feeds" target="_blank" rel="noopener noreferrer">Sync your Outlook calendar with Clio Manage.</a></p>
        <p>After your training session, we will have an onboarding meeting together to go over the most frequent and useful Clio features that you will be working with.</p>
      `, tasks: ['Logged into Clio Manage & Updated password','Installed and logged into Clio Drive / Desktop launcher','Registered for Clio Manage training','Synced Outlook calendar with Clio Manage'] },
      { role:'all', title: 'Clio Manage Task List', content: `
        <p>In addition to regular/ongoing client work, you will be assigned tasks through the <a href="https://app.clio.com/nc/#/tasks" target="_blank" rel="noopener noreferrer">Clio Task List</a> (found on left hand side menu in the Clio web app).</p>
        <p>We will have a meeting together to go over the Clio Task List and how tasks will be handled during the onboarding meeting.</p>
      `},
      { role:'all', title: 'Clio Mobile App', content: `
        <p><a href="https://www.clio.com/features/mobile-app/" target="_blank" rel="noopener noreferrer">Download the Clio Mobile App</a></p>
        <ul>
          <li><a href="https://itunes.apple.com/us/app/clio/id686777370?mt=8" target="_blank" rel="noopener noreferrer">For iOS</a></li>
          <li><a href="https://play.google.com/store/apps/details?id=com.themis.clioAndroid&hl=en_US" target="_blank" rel="noopener noreferrer">For Android</a></li>
        </ul>
        <p>This will be most useful for receiving notifications when tasks are assigned and for quickly scanning materials to client folders if you do not have a standalone scanner.</p>
        <p>Also useful for tracking time when going to Court.</p>
      `, tasks: ['Installed and logged into Clio mobile app'] },
      { role:'all', title: 'Lexis+ Account', content: `
        <p><a href="https://signin.lexisnexis.com/lnaccess/app/signin?back=https%3A%2F%2Fplus.lexis.com%3A443%2Fca&aci=lpc" target="_blank" rel="noopener noreferrer">Lexis+</a> is the primary legal resource for searching case law and practical guidance, the latter being critically important to your practice.</p>
        <div class="kpi" style="padding:12px; background:var(--surface)">
          <div style="font-weight:650; margin-bottom:6px">Credentials</div>
          <div class="row" style="gap:12px">
            <div style="flex:1">
              <label style="font-size:15px; font-weight:650">User</label>
              <input class="input" data-field="workEmail" placeholder="j.smith@hcls.law" aria-label="Lexis+ user (HCLS work email)" readonly>
            </div>
            <div style="flex:1">
              <label style="font-size:15px; font-weight:650">Password</label>
              <p style="margin:8px 0 0; font-size:15px">Master password can be found in your onboarding package. Please update all passwords after logging in.</p>
            </div>
          </div>
        </div>
      `, tasks: ['Logged into Lexis+'] },
      { role:'all', title: 'Setting Up Your Zoom Account', content: `
        <div>
          <p><a href="https://zoom.us/download" target="_blank" rel="noopener noreferrer">Download the Zoom app</a></p>
          <p>Sign in with your Firm email.</p>
        </div>
        <div class="divider"></div>
        <h3 style="margin:0 0 6px">Instant Messaging</h3>
        <p>Zoom serves as the main app for instant communication with other Members of the Network. You will have received an invite via Outlook to join various HCLS groups on Zoom.</p>
        <p>There are several channels with specific purposes which are worth reviewing to know how to make best use of them:</p>
        <ul>
          <li>General</li>
          <li>Procedural Stuff</li>
          <li>Social</li>
          <li>Recommendations (Internal)</li>
          <li>Member Onboarding</li>
          <li>Tech Support</li>
          <li>Legal Research & CPD</li>
          <li>Potential Clients & Firm Communications</li>
          <li>Social Media & HFI</li>
          <li>Billing</li>
        </ul>
        <div class="divider"></div>
        <h3 style="margin:0 0 6px">Phone & Video Communications</h3>
        <p>Zoom also serves as the primary telecommunication tool for handling calls with clients and third parties (both audio and video calls).</p>
        <p>After each phone call or Zoom meeting, an AI-generated summary (not a recording or transcript) is produced for internal use only. These summaries are intended to assist with note-taking and to help ensure all information is captured.</p>
        <p>Zoom AI summaries are not perfect and may contain inconsistencies or inaccuracies. You are responsible for reviewing and revising any summary you use (e.g., when copying and pasting a phone summary into the client's Clio matter "Notes" tab) to correct any errors.</p>
        <p>This is not a replacement for personal note-takingâ€”only an additional support.</p>
        <div class="divider"></div>
        <h3 style="margin:0 0 6px">Scheduler</h3>
        <p>The Zoom Scheduler allows clients and third parties to book a meeting with you directlyâ€”either via videoconference or in personâ€”based on your listed availabilities.</p>
        <p>Because of this, it is especially important to keep your calendar up to date and properly block off times when you are unavailable. This helps prevent unexpected meetings that could take time away from more pressing tasks.</p>
        <p>Connect your Zoom and Outlook calendars to ensure that your availabilities are accurately reflected in both platforms. <a href="https://support.zoom.com/hc/en/article?id=zm_kb&sysparm_article=KB0060774" target="_blank" rel="noopener noreferrer">How to connect Outlook Calendar to Zoom</a>.</p>
        <div class="divider"></div>
        <h3 style="margin:0 0 6px">Tech Support</h3>
        <p>Furthermore, for any tech support requests or process-related issues, Zoom allows remote control of your computer. This enables direct assistance if you encounter IT problems.</p>
        <p>To request IT support, submit a request in the <a href="https://support.zoom.com/hc/en/article?id=zm_kb&sysparm_article=KB0060774" target="_blank" rel="noopener noreferrer">"Tech Support" Zoom channel</a></p>
        <p>This is not monitoring software and does not permit remote access without your consent.</p>
      `, tasks: ['Installed and logged into Zoom app','Linked Outlook calendar with Zoom Scheduler'] },
      { role:'all', title: 'Setting Up Your ChatGPT Account', content: `
        <p>Download the ChatGPT App (the Web App is not recommended)</p>
        <ul>
          <li><a href="https://chatgpt.com/download/" target="_blank" rel="noopener noreferrer">For Desktop</a></li>
        </ul>

        <div class="kpi" style="padding:12px; background:var(--surface)">
          <div style="font-weight:650; margin-bottom:6px">Credentials</div>
          <p style="margin:4px 0"><strong>User:</strong> services@hcls.law</p>
          <p style="margin:4px 0"><strong>Password:</strong> <a href="https://app.clio.com/nc/#/matters/1585181568/notes" target="_blank" rel="noopener noreferrer">Master Password List for Contractors</a></p>
        </div>

        <div class="kpi" style="padding:12px; margin-top:12px">
          <div style="font-weight:650; margin-bottom:6px">Featured Tool</div>
          <p style="margin:4px 0"><strong><a href="https://chatgpt.com/g/g-YcHoEWPOW-text-polisher" target="_blank" rel="noopener noreferrer">Text Polisher</a></strong> turns rough drafts into clean, professional prose. Paste your text and it rewrites it into a polished versionâ€”no prompt required.</p>
        </div>

        <div class="kpi" style="padding:12px; margin-top:12px">
          <div style="font-weight:650; margin-bottom:6px">Best Practices</div>
          <ul style="margin:6px 0 0 22px">
            <li><strong>Delete chats after use</strong> to keep the common-use GPT account clean.</li>
            <li><strong>Do not include PII.</strong> Use placeholders like "Client," "Respondent," etc.</li>
            <li><strong>Crossâ€‘reference sources.</strong> Always verify the output with original materials.</li>
            <li><strong>Assume it may be wrong first.</strong> Treat AI text as a draft to be checked.</li>
            <li><strong>Research caution:</strong> Avoid relying on AI for legal research and don't offload tasks that require "thinking" or "reasoning." Prefer mundane tasks such as rewriting text or finding information in a document.</li>
          </ul>
        </div>

        <div class="kpi" style="padding:12px; margin-top:12px">
          <div style="font-weight:650; margin-bottom:6px">Writing Tip</div>
          <p style="margin:4px 0">Reread generated text to confirm the original intent and meaning are preserved. Minor edits are often needed for accuracy and clarity.</p>
        </div>
        `, tasks: ['Installed ChatGPT Application','I acknowledge the HCLS Best Practices for AI tools','I will cross-reference AI outputs with sources','I will reread AI-generated text to ensure intent is maintained'] },
      { role:'all', title: 'Adobe Acrobat Pro Account', content: `
        <p><a href="https://account.adobe.com/" target="_blank" rel="noopener noreferrer">Log in to your Adobe Acrobat Pro Account</a></p>
        <div class="kpi" id="adobeCredCard" style="padding:12px; background:var(--surface)">
          <div style="font-weight:650; margin-bottom:6px">Credentials</div>
          <div class="row" style="gap:12px">
            <div style="flex:1">
              <label style="font-size:15px; font-weight:650">User</label>
              <input class="input" data-field="workEmail" placeholder="j.smith@hcls.law" aria-label="Adobe user (HCLS work email)" readonly>
            </div>
            <div style="flex:1">
              <label style="font-size:15px; font-weight:650">Password</label>
              <p style="margin:8px 0 0; font-size:15px">Master password can be found in your onboarding package. Please update all passwords after logging in.</p>
            </div>
          </div>
        </div>
      `, tasks: ['Logged into Adobe Acrobat Pro','Downloaded Adobe Acrobat Pro to desktop'] },
      { role:'all', title: 'Reviewing Clio Matters', content: `
        <p>You have been provided access to various <a href="https://app.clio.com/nc/#/matters?status=%7B%22value%22:%22Open%22%7D" target="_blank" rel="noopener noreferrer">open matters</a> in Clio Manage.</p>
        <p>In each matter, review the entries under the "Notes" tabâ€”particularly the Initial Case Consultation (ICC) notesâ€”to gain a general understanding of the case.</p>
        <p>Many notes will appear to contain duplicate information, as they are structured as follows:</p>
        <div class="kpi" style="padding:12px; background:var(--surface)">
          <div style="font-weight:650">[Notes from meeting rewritten by AI]</div>
          <div class="divider" style="margin:8px 0"></div>
          <div style="font-weight:650">[Notes taken down by host during meeting]</div>
        </div>
        <p>After each client meeting, if a significant number of notes were taken, they are rewritten by AI to produce a cleaner, more structured outline of the discussion.</p>
        <p>In the "Documents" tab of each matter, you can review related materials. While there is no expectation to read all materials at this time, it is encouraged to review, at a minimum, the "Orders & Endorsements" folder and/or the most recently edited folders to understand the current status of the case.</p>
        <p>You will meet with the Primary Responsible Lawyer to the client to review the matters you will be initially working on.</p>
      `},
      { role:'all', title: 'Setting Up Your Clio Grow Account', content: `
        <p><a href="https://grow.clio.com/home" target="_blank" rel="noopener noreferrer">Log in to your Clio Grow Account</a></p>
        <ul>
          <li>If you are prompted to select a server, choose "United States/Mexico".</li>
          <li>Use your new Firm provided email</li>
          <li>Your password is the same as the one you setup for Clio Manage.</li>
        </ul>
        <p>Look around the Clio Grow web app and get a feel for it.</p>
        <p><a href="https://help.clio.com/hc/en-us/articles/9290426619675-Navigate-Clio-Grow" target="_blank" rel="noopener noreferrer">Review the Clio Help Centre guide to better understand how the system works.</a></p>
        <p><a href="https://www.clio.com/resources/quick-start-sessions/start-using-clio-grow-today/" target="_blank" rel="noopener noreferrer">Register for a 45-minute training session on how to use Clio Grow.</a></p>
        <p>After your training session, you will meet with Alexander W. Ostheimer-Lebeau to review the most frequently used and relevant Platform features you will be working with.</p>
      `, tasks: ['Logged into Clio Grow account','Registered for Clio Grow training'] },
      { role:'all', title: 'JSO, CaseLines & LAO Portals', content: `
        <p>You will be responsible for filing court materials, uploading client materials, and submitting additional authorizations through the following portals:</p>
        <ul>
          <li><a href="https://signin.ontario.ca/oauth2/aus2957lteAY4cRQK5d7/v1/authorize?response_type=code&client_id=0oacwigwirLU3SBIF5d7&scope=openid+profile&state=mvc1FyLlW3ETYZFEuX1S8CwW6uLRuHxUSO4UAtwY2BE_1755050763588&redirect_uri=https%3A%2F%2Fwww.justiceservices.jus.gov.on.ca%2Foidcclient%2Fpsprod" target="_blank" rel="noopener noreferrer">For JSO</a></li>
          <li><a href="https://ontariocourts.casecenter.thomsonreuters.com/Account/logon?returnUrlId=f0a9ff7b2d5c4d168f835d3ae100b38b&IsSecure=yes" target="_blank" rel="noopener noreferrer">For CaseLines</a></li>
          <li><a href="https://www-pa.legalaidonline.on.ca/psp/paprds/SUPPLIER/FIN/c/LA_TSNR2.LA_S_CIVIL_ACCOUNT.GBL?Page=LA_S_CIVIL_ACCOUNT&Action=A&cmd=login&errorCode=105&languageCd=ENG" target="_blank" rel="noopener noreferrer">For LAO</a></li>
        </ul>
        <p>A masterlist of Network Members' usernames and passwords for the above portals can be found in Clio matter No. 00100, under the "Notes" tab, titled <a href="https://app.clio.com/nc/#/matters/1585181568/notes" target="_blank" rel="noopener noreferrer">"Master Password List for Contractors."</a></p>
        <p>Do not change any settings on these websites or share the passwords outside Matter 00100. Should you be required to update your own password for one of the above portals, you must also update the master list.</p>
      `, tasks: [
        { id:'jso-cred-saved', text:'I have saved my login credentials in the "Master Password List for Contractors" for LAO, JSO, and CaseLines (Lawyers Only)' },
        { id:'jso-cred-update', text:'I will update my login credentials should I be prompted to change them in the future (Lawyers Only)' }
      ] },
      { role:'all', title: 'Break & Refresh', content: `
        <div id="celebrateStep" class="celebrate">
          <h3>Cheers! ðŸ¥‚</h3>
          <p>You've nearly finished the setup&mdash;enjoy a quick break before the final stretch.</p>
        </div>
      `},
      { role:'all', title: 'Website Profile (Optional)', content: `
        <p>You can opt to have your profile displayed on the HCLS website under the "<a href="https://hc-ls.ca/member-network" target="_blank" rel="noopener noreferrer">Member Network</a>" page.</p>
        <p>Should you wish to have a presence there, please draft a brief about yourself (150â€“250 words) and include any distinctive key points you would like to display.</p>
        <p><strong>Tip:</strong> Upload a copy of your resume to ChatGPT and use the following prompt:</p>
        <div class="kpi" style="padding:12px; background:var(--surface)">Based on my resume, draft a brief about me in the third person perspective. Highlight my accomplishments and how the skills I've acquired tie into a family law firm. 150-250 words.</div>
        <p>Edit the prompt and/or the provided answer to your liking before sending it in. You can make use of the Text Polisher agent for this as well.</p>
        <p>This prompt is not requiredâ€”only a recommendation to get a first draft going.</p>
        <p>Send your brief, as well as a professional photo of yourself, to <a href="mailto:admin@hcls.law" style="text-decoration:underline">admin@hcls.law</a></p>
      `, tasks: ['(Optional) Prepared HCLS website profile & professional photo','(Optional) Sent in bio and photo to admin@hcls.law'] },
      { role:'all', title: 'Blog Articles (Optional)', content: `
        <div class="kpi" style="padding:16px">
          <h3 style="margin:0 0 8px">Write and submit your article</h3>
          <p style="margin:8px 0">You can opt to create legal blog articles for the HCLS website on family and/or child protection issues, as well as on other areas of law. You will be credited as the author. The specific topic is at your discretion, provided it has not already been covered by the Firm.</p>
          <p style="margin:8px 0">Articles are to be submitted alongside any invoice for review and approval. For lawyers, each approved article will provide an additional Platform Fee Discount of 0.5% to your next invoice (maximum of +1% per invoice).</p>
          <p style="margin:8px 0">Provide a general overview of the topic, issues, and/or solutions for public readers (non-legally trained). Review the structure of previous HCLS blog submissions for examples of headings, paragraph structure, and style. Choose either a professional neutral tone or a more creative styleâ€”this is your article. For family/child protection articles, end with a section explaining how HCLS can help address the issue.</p>
          <p style="margin:8px 0"><strong>Tip:</strong> You can use AI to rewrite source material. Blog articles for the public are not in-depth academic papers; paraphrase enough to avoid plagiarism while maintaining accuracy.</p>
          <p style="margin:8px 0">Browse published articles: <a href="https://hc-ls.ca/hcls-blog" target="_blank" rel="noopener noreferrer">HCLS Blog</a>.</p>
        </div>
      ` },
      { role:'all', title: 'Home Field Insights (Optional)', content: `
        <div class="kpi" style="padding:16px">
          <h3 style="margin:0 0 8px">Create HFI scripts from blog posts</h3>
          <p style="margin:8px 0">You can opt into preparing short, informative videos that expand on the content of HCLS blog articles, offering a more in-depth review of the topics covered. While some videos may eventually be longer, detailed piecesâ€”such as reviews of notable case lawâ€”will be introduced at a later stage in the development of Home Field Insights (HFI). At this early stage, the primary focus will be on creating scripts based on current HCLS articles. Once these scripts are completed, a proper studio or setup will be arranged for recording purposes.</p>
          <p style="margin:8px 0">Should you opt in, you're encouraged to make use of AI to assist in drafting scripts. For example, you may prompt the AI to create a promotional video script based on an article and then refine the draft to ensure it fits the desired tone and style. The Firm's YouTube channel, Home Field Insights, is aimed at the general public, clients, and students. Although the Firm's webpage is not yet public, the vision for HFI is clear: the videos should match the quality of later LegalEagle productions, including a plug for retaining HCLS to assist with files ("Home Team"). The style should be engaging and approachable rather than corporate or lecture-like, adding a personal "vibe" to the discussion of legal topics. </p>
          <p style="margin:8px 0">Scripts to be submitted alongside any invoice for review and approval. For lawyers, each approved script will provide an additional Platform Fee Discount of 1% to your next invoice (maximum of +2% per invoice). Rates for filming, editing, and posting video content for the Firm will be discussed on a case-by-case basis.</p>
        </div>
      ` },
      { role:'lawyer', title: 'Eâ€‘Signing', content: `
        <ol style="margin-left:18px">
          <li>Enter your Firm email address in <a href="https://app.hellosign.com/account/logIn" target="_blank" rel="noopener noreferrer">HelloSign</a>.</li>
          <li>Select "Forgot your password".</li>
          <li>Follow the steps required to reset your password. You will then be able to log in to HelloSign and manage e-signatures there (this is the primary e-signature client used in Clio).</li>
        </ol>  
        <div class="divider"></div>
        <h3 style="margin:0 0 6px">Signature Branding (Optional)</h3>
        <p>For Lawyers Only: Given the digital nature of the Firm's Platform, you will be signing various documents electronically. As part of the Platform's services to support both your legal work and personal branding, you have the option of obtaining a professionally stylized signature through a <a href="https://artlogo.co/products/signature-logo?variant_id=40741886329038" target="_blank" rel="noopener noreferrer">third-party service</a>.</p>
        <p>This service is reimbursable by the Firm up to a maximum of $100.00 (excl. HST).</p>
        <p>Whether you choose to use a stylized signature or your own, you will be required to upload a ".png" file of your signature to HelloSign when it is time to sign documents electronically.</p>
      `, tasks: ['Logged into HelloSign with Firm email address'] },
      { role:'all', title: 'Security & Confidentiality Guidelines', content: `
        <p><strong>Store Passwords Securely:</strong> All passwords must be stored in a secure, encrypted password manager (e.g., 1Password, LastPass, Bitwarden) rather than written down, saved in unencrypted files, or stored in browsers without encryption. Use unique, complex passwords for each account, and enable multi-factor authentication (MFA) whenever possible. Passwords should never be shared verbally, over unsecured channels, or stored in any location accessible to unauthorized individuals.</p>
        <p><strong>Maintain Professional and Secure Client Communication:</strong> All communication with clients must remain professional in tone, content, and format. Use Platform-provided communication channels (such as official email accounts, secure messaging platforms, or client portals) to ensure confidentiality and compliance with legal obligations. Avoid using personal accounts unless configured for secure use. Ensure all electronic communication is encrypted where possible, and verify client identities before sharing sensitive information.</p>
        <p><strong>Restrict Discussion of Case Details to Authorized Channels:</strong> Never discuss client matters, case strategies, or sensitive details outside of a secure settings. This includes avoiding discussions in public spaces, over unsecured phone lines, on social media, or in casual conversation. Case-related communications should take place only within secure environmentsâ€”either in-person, via secure digital platforms, or through encrypted messaging systems.</p>
        <p><strong>Avoid Storing Sensitive Information in AI Tools:</strong> Do not input, upload, or otherwise store any confidential client information, documents, or case details in AI tools (e.g., ChatGPT, Google Bard, or similar), with exception to Clio Duo. Many AI tools process and store data externally, which may create risks of unauthorized access or data breaches. Only anonymized, non-identifiable information should be used in such tools for drafting, research, or administrative purposes.</p>
        `, tasks:[
          'I will use a password manager to store credentials',
          'I will keep client communications professional and secure',
        'I will not discuss case details outside authorized channels',
        'I will not store sensitive information in AI tools'
      ]},
      { role:'all', title: 'HST Registration', content: `
        <p><strong>HCLS does not provide tax advice. You are recommended to seek guidance from a qualified tax service or professional for additional answers to tax questions.</strong></p>
        <p>This general guide is intended to provide you with an initial walkthrough of registering for a GST/HST number with the Canada Revenue Agency (CRA). You can register online and receive your number immediately.</p>
        <div class="divider"></div>
          <h3 style="margin:10px 0 6px">Steps</h3>
          <ol style="margin-left:18px">
            <li>
              Gather required information:
              <ul>
                <li>Effective date of registration.</li>
                <li>Legal entity information (sole proprietor or corporation; directors/officers for corporations, if applicable).</li>
                <li>SIN and Temporary Tax Number (if applicable).</li>
                <li>Supporting documents as needed (e.g., incorporation docs, evidence of business activity).</li>
              </ul>
            </li>
            <li>
              Register online (preferred): Use CRA's Business Registration Online (BRO): <a href="https://www.canada.ca/en/revenue-agency/services/tax/businesses/topics/registering-your-business/bro-register.html" target="_blank" rel="noopener noreferrer">Register now</a>. In one session you can obtain a 9â€‘digit Business Number (BN) and add a GST/HST (RT) program account.
              <ol style="margin:8px 0 0 18px">
                <li>Access BRO and click "Register now".</li>
                <li>Confirm personal information (must match your last personal return).</li>
                <li>Obtain a BN if you don't already have one; otherwise add a GST/HST account to the BN.</li>
                <li>Select business type (Sole Proprietorship for most individuals; Corporation if incorporated).</li>
                <li>Add owner information and legal name (corporations: exact registered name).</li>
                <li>Business activity: enter "Legal services".</li>
                <li>Provide SIN when prompted.</li>
                <li>Register an RT account; choose effective date and reporting period.</li>
                <li>Confirm details and note your 15â€‘digit GST/HST number.</li>
              </ol>
            </li>
            <li>
              Choose your registration type & effective date:
              <ul>
                <li>Mandatory: usually the date your small-supplier status ended.</li>
                <li>Voluntary: select today or a date up to ~30 days earlier (cannot precede incorporation date for corporations).</li>
              </ul>
            </li>
            <li>
              Record your numbers: Upon approval you'll receive your BN and the 15â€‘digit GST/HST account (e.g., 123456789RT0001). Record these for invoicing and filings.
            </li>
            <li>
              Start your obligations:
              <ul>
                <li>Charge, collect, and remit GST/HST from your effective date.</li>
                <li>File returns as scheduledâ€”even nil returns.</li>
                <li>Electronic filing is generally mandatory (My Business Account, NETFILE, or approved options).</li>
              </ul>
            </li>
            <li>
              Maintain compliance & consider methods:
              <ul>
                <li>Remain registered â‰¥ 1 year before cancelling (unless business ceases).</li>
                <li>Consider Quick Method eligibility to simplify remittances.</li>
                <li>Claim input tax credits (ITCs) where eligible.</li>
              </ul>
            </li>
          </ol>
          
          <p>CRA business enquiries: 1â€‘800â€‘959â€‘5525.</p>
        `, tasks:[
          { id:'hst-gather', text:'I gathered required personal/corporate details and effective date' },
          { id:'hst-register', text:'I registered for BN and GST/HST (BRO or RC1)' },
          { id:'hst-effective-date', text:'I selected appropriate effective date' },
          { id:'hst-record', text:'I recorded BN and GST/HST account number' },
          { id:'hst-obligations', text:'I understand that I must charge/collect/file/remit my financial obligations' },
          { id:'hst-quick-method', text:'I reviewed the Quick Method and ITCs considerations' },
          { id:'hst-disclaimer', text:'I understand that HCLS is not providing me with financial or taxation advice, and that the above guide is for informational purposes only' }
        ]},
      { role:'all', title: 'Completion Checklist & Acknowledgment', content: `
        <p>Please return a signed copy of this onboarding guide to <a href="mailto:admin@hcls.law" style="text-decoration:underline">admin@hcls.law</a>, alongside your profile bio and photo (optional).</p>
        <p>A review meeting will be scheduled to go over specifics, address any questions you may have, and to assist you with any steps in this onboarding guide you were unable to complete.</p>
        <p>For receiving payments when submitting invoices to HCLS, please confirm the email address at which you wish to receive eâ€‘transfers:</p>
          <input class="input" data-field="etransferEmail" placeholder="______________________________" aria-label="E-transfer email placeholder">
        <div class="divider"></div>
        <p style="font-weight:650">I confirm that I have read the HCLS onboarding guide and completed all applicable steps outlined above.</p>
        <div class="row" style="gap:12px">
            <div style="flex:1"><label style="font-size:15px; font-weight:650">Date</label><input class="input" data-field="confirmDate" placeholder="_____________________"></div>
            <div style="flex:1"><label style="font-size:15px; font-weight:650">Name</label><input class="input" data-field="confirmName" placeholder="_____________________"></div>
            <div style="flex:1">
              <label style="font-size:15px; font-weight:650">Signature</label>
              <div class="signature-box"></div>
              <div class="signature-hint" style="font-size:12px; color:var(--muted); margin-top:6px">Print and sign this page, or insert a digital signature after saving to PDF.</div>
        </div>
        </div>
        <div class="divider print-break-before"></div>
        <p style="font-weight:650" class="print-break-before">Checklist</p>
        <ul id="finalChecklist" class="print-break-before"></ul>
        <div class="row" style="justify-content:space-between; margin-top:16px">
          <button class="btn-ghost" id="finalPrintBtn" title="Print or Save as PDF">Print / Save PDF</button>
          <button class="btn-brand" id="finishBtn" title="Finish Onboarding">Finish</button>
        </div>
      `}
    ];

    // ----- State -----
    let role = 'lawyer';
    let current = 0;
    let checked = {};
      let fields = {};
    let theme = 'light';
    // Highest sidebar step index the user has unlocked (persists across sessions)
    let furthestUnlocked = 0;

    // Elements
    const sidebar = document.getElementById('sidebar');
    function scrollActiveStepIntoCenter(){
      const active = sidebar.querySelector('.step.active');
      if(!active) return;
      const container = sidebar;
      const containerHeight = container.clientHeight;
      const activeTop = active.offsetTop - container.offsetTop;
      const activeHeight = active.offsetHeight;
      const targetScrollTop = activeTop - (containerHeight/2 - activeHeight/2);
      container.scrollTo({ top: Math.max(0, targetScrollTop), behavior: 'smooth' });
    }
    const stepTitle = document.getElementById('stepTitle');
    const stepBody = document.getElementById('stepBody');
    const tasksWrap = document.getElementById('tasksWrap');
    const tasksList = document.getElementById('tasksList');
    const backBtn = document.getElementById('backBtn');
    const nextBtn = document.getElementById('nextBtn');
    // Wrap Next button to host inline warning message beneath it
    try{
      const nextBtnWrapper = document.createElement('div');
      nextBtnWrapper.style.display = 'flex';
      nextBtnWrapper.style.flexDirection = 'column';
      nextBtnWrapper.style.alignItems = 'flex-end';
      const nextParent = nextBtn.parentElement;
      if(nextParent){
        nextParent.replaceChild(nextBtnWrapper, nextBtn);
        nextBtnWrapper.appendChild(nextBtn);
        const nextWarning = document.createElement('div');
        nextWarning.id = 'nextWarning';
        nextWarning.className = 'field-error';
        nextWarning.style.display = 'none';
        nextWarning.style.maxWidth = '520px';
        nextWarning.style.textAlign = 'right';
        nextWarning.style.marginTop = '6px';
        nextBtnWrapper.appendChild(nextWarning);
      }
    }catch{}
    const bar = document.getElementById('bar');
    const pct = document.getElementById('pct');
    const saveDot = document.getElementById('saveDot');
    const saveText = document.getElementById('saveText');
    const segs = [];
    const themeSegs = [];
    const landing = document.getElementById('landing');
    const landingUid = document.getElementById('landingUid');
    const landingApply = document.getElementById('landingApply');
    const landingMsg = document.getElementById('landingMsg');

    // Load persisted
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        const state = JSON.parse(raw)||{};
        const version = state.schemaVersion || 0;
        if(version !== SCHEMA_VERSION){
          // Incompatible schema: keep role and theme if present; reset others
          role = state.role || role;
          theme = state.theme || theme;
          checked = {};
          current = 0;
          fields = {};
          furthestUnlocked = 0;
        }else{
          checked = state.checked||{}; current = state.current||0; role = state.role||'lawyer'; fields = state.fields||{}; theme = state.theme||'light';
          furthestUnlocked = (typeof state.furthestUnlocked === 'number') ? state.furthestUnlocked : current;
        }
      }
    }catch{}

    // Helpers
    const debounce = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
    const persist = debounce(()=>{
        try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({schemaVersion: SCHEMA_VERSION, checked, current, role, fields, theme, furthestUnlocked})); }catch{}
      saveDot.className='dot saved'; saveText.textContent='Saved';
      const saveState = document.getElementById('saveState'); if(saveState){ saveState.classList.add('flash'); setTimeout(()=> saveState.classList.remove('flash'), 650); }
    }, 300);
    const setSaving = ()=>{ saveDot.className='dot saving'; saveText.textContent='Savingâ€¦'; };

    function applyTheme(){ document.documentElement.setAttribute('data-theme', 'light'); }

    // Firm logo hardcoded in HTML; no dynamic source needed

    const visibleSteps = ()=> stepsData.filter((s, idx)=> (s.role==='all' || s.role===role) && idx!==0);
    const allTaskIds = ()=> visibleSteps().flatMap(s => (s.tasks||[]).map(t => slug((s.key||s.title)+'-'+(t.id||t))));

      function bindFields(){
        // Attach to inputs/selects in current step
        const inputs = stepBody.querySelectorAll('[data-field]');
        inputs.forEach(el=>{
          const key = el.getAttribute('data-field');
          if(fields[key] !== undefined){ el.value = fields[key]; }
          el.addEventListener('input', ()=>{ setSaving(); fields[key] = el.value; validateField(key); if(key==='fullName') updateWorkEmailFromFullName(); persist(); });
          el.addEventListener('change', ()=>{ setSaving(); fields[key] = el.value; validateField(key); if(key==='fullName') updateWorkEmailFromFullName(); persist(); });
          validateField(key);
        });
        // Ensure computed work email reflects full name on initial render of this step
        updateWorkEmailFromFullName();
      }

      function validateField(key){
        const errorEl = stepBody.querySelector(`[data-error-for="${key}"]`);
        if(!errorEl) return;
        let msg = '';
        if(key==='clioManageTrainingDate' || key==='clioGrowTrainingDate'){
          const val = fields[key];
          if(val){
            const d = new Date(val);
            const today = new Date();
            today.setHours(0,0,0,0);
            if(d < today){ msg = 'Please select a date today or in the future.'; }
          }
        }
        errorEl.textContent = msg;
      }

      function wireStepSpecific(){
        // Signature generator wiring
        const genBtn = document.getElementById('genSigBtn');
        const copyBtn = document.getElementById('copySigBtn');
        const useProfileBtn = document.getElementById('useProfileBtn');
        const out = document.getElementById('sigOutput');
        // Unique ID apply button
        const applyUniqueBtn = document.getElementById('applyUniqueBtn');
        if(applyUniqueBtn){
          applyUniqueBtn.onclick = ()=>{
            const uidInput = stepBody.querySelector('[data-field="uniqueId"]');
            const uid = (uidInput?.value||'').trim().toUpperCase();
            if(!uid) return;
            const preset = getPresetForUniqueId(uid);
            if(preset){
              setSaving();
              fields.fullName = preset.fullName;
              fields.workEmail = preset.workEmail;
              fields.phoneExt = preset.phoneExt || fields.phoneExt;
              fields.title = preset.title || fields.title;
              fields.uniqueId = uid;
              fields.meetingLink = preset.meetingLink || fields.meetingLink;
              fields.__masterPassword = preset.password;
              persist();
              // Force refresh so bound fields update across steps
              saveAndRender();
            }
          };
        }
        if(genBtn){
          genBtn.onclick = ()=>{
            const outDiv = document.getElementById('sigOutput');
            if(outDiv){ outDiv.innerText = buildSignatureBlock(); setSaving(); persist(); }
          };
        }
        if(copyBtn){
          copyBtn.onclick = ()=>{ try{ const outDiv = document.getElementById('sigOutput'); navigator.clipboard.writeText(outDiv?.innerText||''); }catch{} };
        }

        // Outlook signature preview and copy (Stage 4)
        const outlookSigPreview = document.getElementById('outlookSignaturePreview');
        if(outlookSigPreview){
          try{ outlookSigPreview.innerHTML = buildOutlookHtmlSignature(); }catch{}
        }
        // Adobe (Stage 12) conditional rendering by role: show student/law clerk shared credentials only for non-lawyers
        try{
          const isAdobeStep = ((s?.title||'').toLowerCase().includes('adobe acrobat pro account'));
          if(isAdobeStep && !isLawyerTitle){
            const card = document.getElementById('adobeCredCard');
            if(card && !card.dataset.wired){
              card.dataset.wired = 'true';
              card.innerHTML = `
                <div style="font-weight:650; margin-bottom:6px">Credentials</div>
                <p style="margin:4px 0"><strong>User:</strong> services@hcls.law</p>
                <p style="margin:4px 0"><strong>Password:</strong> <a href="https://app.clio.com/nc/#/matters/1585181568/notes" target="_blank" rel="noopener noreferrer">Master Password List for Contractors</a></p>
                <p style="margin:8px 0 0; font-size:14px; color: var(--muted)">For students/law clerks only. Lawyers must sign in with their provided HCLS email and their own password.</p>
              `;
            }
          }
        }catch{}
        const copyOutlookSigBtn = document.getElementById('copyOutlookSigBtn');
        if(copyOutlookSigBtn){
          copyOutlookSigBtn.onclick = async ()=>{
            const html = buildOutlookHtmlSignature();
            try{
              const blob = new Blob([html], { type: 'text/html' });
              const data = [new ClipboardItem({ 'text/html': blob })];
              await navigator.clipboard.write(data);
            }catch{
              try{ await navigator.clipboard.writeText(html); }catch{}
            }
          };
        }
        if(useProfileBtn){
          useProfileBtn.onclick = ()=>{
            // Prefill signature inputs from profile
            const map = {
              sig_name: fields.fullName || '',
              sig_title: fields.title || '',
              sig_credentials: fields.credentials || '',
              sig_ext: fields.phoneExt || '',
              sig_email: fields.workEmail || ''
            };
            Object.entries(map).forEach(([k,v])=>{ fields[k]=v; });
            bindFields();
            setSaving(); persist();
          };
        }
        // Auto-fill signature inputs from stored fields on render
        const sigMap = {
          sig_name: fields.fullName || '',
          sig_title: fields.title || '',
          sig_credentials: fields.credentials || '',
          sig_ext: fields.phoneExt || '',
          sig_email: fields.workEmail || ''
        };
        Object.entries(sigMap).forEach(([k,v])=>{
          const el = stepBody.querySelector(`[data-field="${k}"]`);
          if(el && !el.value){ el.value = v; fields[k] = el.value; }
        });

          // Celebration confetti effect
          const celebrateStep = document.getElementById('celebrateStep');
          if(celebrateStep && !celebrateStep.dataset.wired){
            celebrateStep.dataset.wired = 'true';
            for(let i=0;i<60;i++){
              const piece = document.createElement('span');
              piece.className = 'confetti-piece';
              piece.style.left = Math.random()*100 + '%';
              piece.style.background = `hsl(${Math.random()*360},70%,60%)`;
              piece.style.animationDelay = (Math.random()*1.5) + 's';
              celebrateStep.appendChild(piece);
              setTimeout(()=>piece.remove(),3000);
            }
          }
        }

        // Automatically wrap contiguous non-card content blocks into soft cards
        // for consistent layout across steps. Existing `.kpi` blocks and `.divider`
        // boundaries are respected and not re-wrapped.
        function cardifyStepSections(){
          try{
            const root = stepBody;
            if(!root) return;
            let el = root.firstElementChild;
            while(el){
              const isCard = el.classList && el.classList.contains('kpi');
              const isDivider = el.classList && el.classList.contains('divider');
              if(isCard || isDivider){ el = el.nextElementSibling; continue; }
              const wrapper = document.createElement('div');
              wrapper.className = 'kpi';
              wrapper.style.padding = '12px';
              wrapper.style.background = 'var(--surface)';
              root.insertBefore(wrapper, el);
              let movedAny = false;
              while(wrapper.nextElementSibling){
                const nxt = wrapper.nextElementSibling;
                const nxtIsCard = nxt.classList && nxt.classList.contains('kpi');
                const nxtIsDivider = nxt.classList && nxt.classList.contains('divider');
                if(nxtIsCard || nxtIsDivider) break;
                wrapper.appendChild(nxt);
                movedAny = true;
              }
              if(!movedAny){ wrapper.remove(); el = el.nextElementSibling; }
              else { el = wrapper.nextElementSibling; }
            }
          }catch{}
        }

      function buildSignatureBlock(){
        const name = (fields.sig_name||'NAME');
        const creds = (fields.sig_credentials||'AccrÃ©ditations');
        const title = (fields.sig_title||'TITLE');
        const ext = (fields.sig_ext||'100');
        const email = (fields.sig_email||fields.workEmail||'awol@hcls.law');
        return [
          'Thank you.',
          '',
          'Sincerely,',
          '',
          `${name}, ${creds}`,
          '',
          title,
          '',
          '',
          'Home Counsel Legal Services',
          'Professional Corporation',
          '',
          '',
          '',
          `Phone: (613) 519-4518 ext. ${ext}`,
          '',
          `Email: ${email}`,
          '',
          '',
          'Address: 116 Lisgar St., 6th Floor',
          'Ottawa, Ontario K2P 0C2',
          '',
          'Website: www.hcls.law',
          '',
          '',
          '',
          'Book a Meeting / Leave a Review',
          '',
          '',
          '',
          "Important: The contents of this email and any attachments are confidential. They are intended for the named recipient(s) only. If you have received this email by mistake, please notify the sender immediately and do not disclose the contents to anyone or make copies thereof. / Le contenu de ce courriel et de toute piÃ¨ce jointe est confidentiel. Ils sont destinÃ©s au(x) destinataire(s) dÃ©signÃ©(s) uniquement. Si vous avez reÃ§u ce courriel par erreur, veuillez en informer immÃ©diatement l'expÃ©diteur et ne divulguez le contenu Ã  personne et n'en faites aucune copie."
        ].join('\n');
      }

      function escapeHtml(value){
        return String(value||'')
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;')
          .replace(/'/g,'&#39;');
      }

      function buildOutlookHtmlSignature(){
        const name = escapeHtml(fields.fullName || fields.sig_name || 'NAME');
        const credsRaw = fields.credentials || fields.sig_credentials || '';
        const creds = escapeHtml(credsRaw);
        const title = escapeHtml(fields.title || fields.sig_title || 'TITLE');
        const ext = escapeHtml(fields.phoneExt || fields.sig_ext || '100');
        const email = escapeHtml(fields.workEmail || fields.sig_email || 'awol@hcls.law');
        // Display site as www.hcls.law but link to primary site
        const websiteUrl = 'https://hc-ls.ca';
        const websiteText = 'www.hcls.law';
        const addressLine1 = '116 Lisgar St., 6<sup>th</sup> Floor';
        const addressLine2 = 'Ottawa, Ontario K2P 0C2';
        const meetingHref = String(fields.meetingLink||'').trim() || 'https://www.hcls.law/book';
        // If title is not exactly "Lawyer", point to Services page for booking
        const normalizedTitle = (fields.title || fields.sig_title || '').trim().toLowerCase();
        const isLawyerTitle = normalizedTitle === 'lawyer';
        const bookLink = isLawyerTitle ? meetingHref : 'https://hc-ls.ca/services';

        // Exact 2x7 table structure requested
        return `
<div style="font-family:'EB Garamond', Garamond, serif; font-size:12pt; line-height:1.5;">
  <p style="margin:0">Thank you.</p>
  <!-- Blank paragraph (one space) to create subtle gap between the two lines -->
  <p style="margin:0; line-height:1; font-size:12pt">&nbsp;</p>
  <p style="margin:0">Sincerely,</p>
</div>
<div style="height:6pt; font-size:0; line-height:0;">&nbsp;</div>
<table role="presentation" cellpadding="0" cellspacing="0" border="0" width="470" style="font-family:'EB Garamond', Garamond, serif; color:#000; line-height:1.15; border-collapse:collapse;">
  <!-- Row 1: merged columns; left border present and horizontal rule below -->
  <tr>
    <td colspan="2" style="border-left:2px solid #000; padding:0 0 0 12pt; border-bottom:1pt solid #000;">
      <div style="font-size:12pt; font-weight:bold; padding:2pt 0;">${name}${creds?`, <span style=\"font-size:8pt; font-style:italic; font-weight:400; vertical-align:sub;\">${creds}</span>`:''}</div>
      <p style="margin:2pt 0 0 0; font-size:11pt;">${title}</p>
      <!-- Blank paragraph containing one space to create a subtle gap -->
      <p style="margin:0; font-size:6pt; line-height:6pt;">&nbsp;</p>
      <p style="margin:0; font-size:12pt; font-weight:bold;">Home Counsel Legal Services</p>
      <p style="margin:2pt 0 6pt 0; font-size:11pt;">Professional Corporation</p>
    </td>
  </tr>
  <!-- Row 2: blank spacer; must keep left border to continue line; no top/bottom borders -->
  <tr>
    <td style="border-left:2px solid #000; padding-left:12pt; height:8pt; font-size:0; line-height:0;">&nbsp;</td>
    <td style="height:8pt; font-size:0; line-height:0;">&nbsp;</td>
  </tr>
  <!-- Row 3: phone | email (left border only on col 1) -->
  <tr>
    <td style="border-left:2px solid #000; padding:4pt 12pt 0 12pt; font-size:11pt; vertical-align:top;">
      <strong>Phone:</strong> (613) 519-4518 ext. ${ext}
    </td>
    <td style="padding:4pt 0 0 12pt; font-size:11pt; vertical-align:top;">
      <strong>Email:</strong> <a href="mailto:${email}" style="color:#2a6496; text-decoration:underline;">${email}</a>
    </td>
  </tr>
  <!-- Row 4: address | website (left border only on col 1) -->
  <tr>
    <td style="border-left:2px solid #000; padding:4pt 12pt 6pt 12pt; font-size:11pt; vertical-align:top;">
      <strong>Address:</strong> 116 Lisgar St., 6<sup>th</sup> Floor<br/>Ottawa, Ontario K2P 0C2
    </td>
    <td style="padding:4pt 0 6pt 12pt; font-size:11pt; vertical-align:top;">
      <strong>Website:</strong> <a href="${websiteUrl}" style="color:#2a6496; text-decoration:underline;" target="_blank" rel="noopener noreferrer">${websiteText}</a>
    </td>
  </tr>
  <!-- Row 5: blank spacer (no borders) -->
  <tr>
    <td style="height:10pt; font-size:0; line-height:0;">&nbsp;</td>
    <td style="height:10pt; font-size:0; line-height:0;">&nbsp;</td>
  </tr>
  <!-- Row 6: links merged across columns -->
  <tr>
    <td colspan="2" style="font-size:11pt; font-weight:700; padding-left:12pt;">
      <a href="${bookLink}" style="color:#2a6496; text-decoration:underline;" target="_blank" rel="noopener noreferrer">Book a Meeting</a>
      <span style="color:#000;"> / </span>
      <a href="https://g.page/r/CV6EBQlCrxh2EAI/review" style="color:#2a6496; text-decoration:underline;" target="_blank" rel="noopener noreferrer">Leave a Review</a>
    </td>
  </tr>
  <!-- Row 7: disclaimer merged across both columns -->
  <tr>
    <td colspan="2" style="font-size:6.5pt; color:#000; padding-top:8pt; text-align:justify; text-justify:inter-word;">
      <strong>Important:</strong> The contents of this email and any attachments are confidential. They are intended for the named recipient(s) only. If you have received this email by mistake, please notify the sender immediately and do not disclose the contents to anyone or make copies thereof. / Le contenu de ce courriel et de toute piÃ¨ce jointe est confidentiel. Ils sont destinÃ©s au(x) destinataire(s) dÃ©signÃ©(s) uniquement. Si vous avez reÃ§u ce courriel par erreur, veuillez en informer immÃ©diatement l'expÃ©diteur et ne divulguez le contenu Ã  personne et n'en faites aucune copie.
    </td>
  </tr>
</table>`;
      }

      function normalizeLetters(value){
        return (value||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
      }
      function computeWorkEmailFromFullName(fullName){
        const clean = (s)=> normalizeLetters(String(s||'').toLowerCase()).replace(/[^a-z]/g,'');
        const parts = String(fullName||'').trim().split(/\s+/).filter(Boolean);
        if(parts.length===0) return '';
        const first = parts[0];
        const last = parts[parts.length-1];
        const initial = clean(first).charAt(0);
        const lastClean = clean(last);
        if(!initial || !lastClean) return '';
        return `${initial}.${lastClean}@hcls.law`;
      }
      function updateWorkEmailFromFullName(){
        // Prefer preset work email if provided from unique ID
        const derived = fields.workEmail || computeWorkEmailFromFullName(fields.fullName||'');
        if(derived){ fields.workEmail = derived; }
        const emailInput = stepBody.querySelector('[data-field="workEmail"]');
        if(emailInput){ emailInput.value = fields.workEmail || derived || ''; }
      }

      function loadPresets(){
        try{
          const raw = localStorage.getItem(PRESETS_KEY);
          if(raw){
            const existing = JSON.parse(raw)||{};
            // Remove any existing entries related to Melanie
            try{
              if(existing['92366S']){ delete existing['92366S']; }
              Object.entries(existing).forEach(([k,v])=>{
                const fullName = String((v&&v.fullName)||'').toLowerCase();
                const email = String((v&&v.workEmail)||'').toLowerCase();
                if(fullName.includes('melanie') || email.includes('m.radovan@hcls.law')){ delete existing[k]; }
              });
            }catch{}
            const additions = {
              '92501I': { fullName:'Tyler Lett', workEmail:'t.lett@hcls.law', phoneExt:'105', title:'Lawyer', meetingLink:'https://hcls-law.zoom.us/zbook/hcls-lett' },
              '91973W': { fullName:'Kyle Lionel Thompson', workEmail:'k.thompson@hcls.law', phoneExt:'102', title:'Lawyer', meetingLink:'https://hcls-law.zoom.us/zbook/hcls-thompson' },
              'M_PATTEN': { fullName:'Matthew Patten', workEmail:'m.patten@hcls.law', phoneExt:'101', title:'Student-at-Law' },
              'K_GL': { fullName:'Kim Gagnon-Lalonde', workEmail:'k.gagnon-lalonde@hcls.law', phoneExt:'101', title:'Law Clerk / Student-at-Law' }
            };
            Object.entries(additions).forEach(([k,v])=>{ if(!existing[k]) existing[k]=v; });
            // Ensure booking links are set even if presets already exist
            if(existing['91973W']){ existing['91973W'].meetingLink = 'https://hcls-law.zoom.us/zbook/hcls-thompson'; }
            if(existing['92501I']){ existing['92501I'].meetingLink = 'https://hcls-law.zoom.us/zbook/hcls-lett'; }
            try{ localStorage.setItem(PRESETS_KEY, JSON.stringify(existing)); }catch{}
            return existing;
          }
        }catch{}
        const seed = {
          '92501I': { fullName:'Tyler Lett', workEmail:'t.lett@hcls.law', phoneExt:'105', title:'Lawyer', meetingLink:'https://hcls-law.zoom.us/zbook/hcls-lett' },
          '91973W': { fullName:'Kyle Lionel Thompson', workEmail:'k.thompson@hcls.law', phoneExt:'102', title:'Lawyer', meetingLink:'https://hcls-law.zoom.us/zbook/hcls-thompson' },
          'M_PATTEN': { fullName:'Matthew Patten', workEmail:'m.patten@hcls.law', phoneExt:'101', title:'Student-at-Law' },
          'K_GL': { fullName:'Kim Gagnon-Lalonde', workEmail:'k.gagnon-lalonde@hcls.law', phoneExt:'101', title:'Law Clerk / Student-at-Law' }
        };
        try{ localStorage.setItem(PRESETS_KEY, JSON.stringify(seed)); }catch{}
        return seed;
      }
      function savePresets(p){ try{ localStorage.setItem(PRESETS_KEY, JSON.stringify(p||{})); }catch{} }
      function getPresetForUniqueId(uid){
        const presets = loadPresets();
        const key = String(uid||'').toUpperCase();
        return presets[key] || null;
      }

    function showToast(message){
      try{
        const root = document.getElementById('toastRoot');
        if(!root) return;
        const el = document.createElement('div');
        el.className = 'toast';
        el.textContent = message;
        root.appendChild(el);
        const close = ()=>{ el.style.animation = 'toastOut .25s ease forwards'; setTimeout(()=> el.remove(), 250); };
        setTimeout(close, 2400);
      }catch{}
    }

    // Inline warning/confirm helpers for Next flow
    function showNextWarning(text){
      try{
        const el = document.getElementById('nextWarning');
        if(el){ el.innerHTML = text; el.style.display = ''; }
      }catch{}
    }
    function hideNextWarning(){
      try{
        const el = document.getElementById('nextWarning');
        if(el){ el.style.display = 'none'; el.innerHTML = ''; }
      }catch{}
    }
    function enterNextConfirmMode(message){
      try{
        nextBtn.textContent = 'Yes, I want to proceed';
        nextBtn.title = 'Proceed despite outstanding tasks';
        nextBtn.dataset.confirm = 'true';
        showNextWarning(message);
      }catch{}
    }
    function resetNextConfirmMode(){
      try{
        delete nextBtn.dataset.confirm;
        // Respect current step context for label
        const isLast = current === (visibleSteps().length - 1);
        nextBtn.textContent = isLast ? 'Finish' : 'Next';
        nextBtn.title = isLast ? 'Finish Onboarding' : 'Next';
        hideNextWarning();
      }catch{}
    }

    function updateProgress(){
      const ids = allTaskIds();
      const done = ids.filter(id=>checked[id]).length;
      const p = ids.length? Math.round(done/ids.length*100) : 0;
      const prev = Number((pct.textContent||'0').replace(/%/g,''))||0;
      bar.style.width = p + '%'; pct.textContent = p + '%';
      if(p>prev){ bar.classList.add('shimmer'); setTimeout(()=> bar.classList.remove('shimmer'), 650); }
      // Milestone toasts
      const milestones = [25,50,75,100];
      if(milestones.includes(p) && p>prev){ showToast(p===100 ? 'Onboarding complete! ðŸŽ‰' : `Nice progress â€” ${p}% complete`); }
    }

    function renderSidebar(){
      const steps = visibleSteps();
      if(current >= steps.length) current = 0;
      sidebar.innerHTML='';
      steps.forEach((s, idx)=>{
        const stepTasks = (s.tasks||[]).map(t=>slug((s.key||s.title)+'-'+(t.id||t)));
        const doneInStep = stepTasks.filter(id=>checked[id]).length;
        const totalInStep = stepTasks.length;
        const btn = document.createElement('button');
        const furthest = getFurthestStepIndex();
        const isDisabled = idx > furthest;
        btn.className = 'step' + (idx===current? ' active':'') + (isDisabled? ' disabled':'');
        btn.setAttribute('data-step-index', String(idx));
        // Determine completion state for color
        let stateColor = '#a3a3a3'; // gray locked by default
        const totalInStepForColor = (s.tasks||[]).length;
        if(!isDisabled){
          if(totalInStepForColor===0){
            // No tasks: green if we've moved past this step; yellow if current
            stateColor = (idx < current) ? '#10b981' : '#f59e0b';
          }else if(doneInStep>=totalInStepForColor){
            stateColor = '#10b981'; // green completed
          }else{
            stateColor = '#f59e0b'; // yellow in progress
          }
        }
        const lockIcon = isDisabled
          ? `<svg viewBox="0 0 24 24" fill="none" stroke="${stateColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`
          : `<svg viewBox="0 0 24 24" fill="none" stroke="${stateColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"/><path d="M7 11V9a5 5 0 0 1 9.5-2"/></svg>`;
        btn.innerHTML = `
          <div style="display:flex; align-items:flex-start; gap:8px; justify-content:space-between">
            <div style="flex:1; padding-right:28px">
              <div class="title">${idx+1}. ${s.title}</div>
              ${s.tag?`<div class="tag">${s.tag}</div>`:''}
            </div>
            <div class="count" style="margin-right:20px">${ totalInStep? `${doneInStep}/${totalInStep}` : ''}</div>
          </div>`;
        const iconWrap = document.createElement('div');
        iconWrap.className = 'status-icon';
        iconWrap.innerHTML = lockIcon;
        btn.appendChild(iconWrap);
        // Keyboard and mouse activation
        btn.addEventListener('click', ()=>{
          // Allow navigation to any unlocked step (<= furthest completed), disallow future locked steps
          const furthest = getFurthestStepIndex();
          if(idx <= furthest){ current = idx; saveAndRender(false); }
        });
        btn.addEventListener('keydown', (e)=>{
          if(e.key==='Enter' || e.key===' '){ e.preventDefault(); btn.click(); }
          if(e.key==='ArrowDown'){ e.preventDefault(); const n = sidebar.querySelector(`button.step[data-step-index="${idx+1}"]`); if(n) n.focus(); }
          if(e.key==='ArrowUp'){ e.preventDefault(); const p = sidebar.querySelector(`button.step[data-step-index="${idx-1}"]`); if(p) p.focus(); }
        });
        sidebar.appendChild(btn);
      });
      scrollActiveStepIntoCenter();
    }

    function getFurthestStepIndex(){
      // Allow navigation to any step whose index is <= furthestUnlocked
      return Math.max(0, furthestUnlocked|0);
    }

    function renderMain(){
      const steps = visibleSteps();
      const s = steps[current];
      stepTitle.textContent = s?.title || '';
      stepTitle.classList.remove('reveal'); void stepTitle.offsetWidth; stepTitle.classList.add('reveal');
      stepBody.innerHTML = s?.content || '';
      // Determine lawyer status by Title field (strict equality to "Lawyer")
      const isLawyerTitle = ((fields.title||'').trim().toLowerCase() === 'lawyer');
      // Lexis+ (Stage 9) conditional rendering by role: show inputs only for lawyers; otherwise show guidance text
      try{
        const isLexisStep = ((s?.title||'').toLowerCase().includes('lexis+'));
        if(isLexisStep && !isLawyerTitle){
          const guidanceUser = "Use your academic institution's email address to access Lexis+.";
          const guidancePass = "Use your academic institution's account password to access Lexis+.";
          // Replace the User input with guidance text
          const userLabel = Array.from(stepBody.querySelectorAll('label')).find(l => (l.textContent||'').trim().toLowerCase() === 'user');
          if(userLabel && userLabel.parentElement){
            const parent = userLabel.parentElement;
            // Remove any existing input under User
            const existingInput = parent.querySelector('input');
            if(existingInput){ existingInput.remove(); }
            // Ensure a paragraph exists with guidance
            let p = parent.querySelector('p');
            if(!p){ p = document.createElement('p'); p.style.margin = '8px 0 0'; p.style.fontSize = '15px'; parent.appendChild(p); }
            p.textContent = guidanceUser;
          }
          // Replace the Password paragraph with guidance text
          const passLabel = Array.from(stepBody.querySelectorAll('label')).find(l => (l.textContent||'').trim().toLowerCase() === 'password');
          if(passLabel && passLabel.parentElement){
            const parent = passLabel.parentElement;
            let p = parent.querySelector('p');
            if(!p){ p = document.createElement('p'); p.style.margin = '8px 0 0'; p.style.fontSize = '15px'; parent.appendChild(p); }
            p.textContent = guidancePass;
          }
        }
      }catch{}
      // Adobe (Stage 12) conditional rendering by role: show student/law clerk shared credentials only for non-lawyers
      try{
        const isAdobeStep = ((s?.title||'').toLowerCase().includes('adobe acrobat pro account'));
        if(isAdobeStep && !isLawyerTitle){
          const card = document.getElementById('adobeCredCard');
          if(card){
            card.innerHTML = `
              <div style="font-weight:650; margin-bottom:6px">Credentials</div>
              <p style="margin:4px 0"><strong>User:</strong> services@hcls.law</p>
              <p style="margin:4px 0"><strong>Password:</strong> <a href="https://app.clio.com/nc/#/matters/1585181568/notes" target="_blank" rel="noopener noreferrer">Master Password List for Contractors</a></p>
            `;
          }
        }
      }catch{}
      const pctEl = document.getElementById('pct'); if(pctEl){ pctEl.setAttribute('aria-live','polite'); }
        bindFields();
        wireStepSpecific();
        // Assign stagger indices for card entrance animation
        try{
          [...stepBody.querySelectorAll('.kpi')].forEach((el, i)=> el.style.setProperty('--i', i));
          [...stepBody.querySelectorAll('.divider')].forEach(div => div.classList.add('reveal'));
        }catch{}
        cardifyStepSections();
          // Keep profile title synced with selected role when Profile & Role step is displayed
          if((s?.title||'').toLowerCase().includes('profile')){ syncTitleWithRole(); }
          // Auto-fill final stage date & name
          if((s?.title||'').toLowerCase().includes('completion checklist')){
            const dateInput = stepBody.querySelector('[data-field="confirmDate"]');
            const nameInput = stepBody.querySelector('[data-field="confirmName"]');
            if(dateInput){ const today = new Date(); const fmt = today.toLocaleDateString(undefined, { year:'numeric', month:'long', day:'numeric' }); if(!dateInput.value) dateInput.value = fmt; }
            if(nameInput && !nameInput.value){ nameInput.value = fields.fullName || ''; }
          }

        // Replace any visible password notices with preset password if unique ID provided (lawyers only),
        // but do not modify the ChatGPT step which now has static credentials.
        const isChatGPTStep = ((s?.title||'').toLowerCase().includes('chatgpt'));
        if(fields.__masterPassword && isLawyerTitle && !isChatGPTStep){
          const labels = stepBody.querySelectorAll('label');
          labels.forEach(l=>{
            const text = (l.textContent||'');
            if(/pass(word)?/i.test(text)){
              l.textContent = 'Password';
              const para = l.parentElement?.querySelector('p');
              if(para){ para.textContent = fields.__masterPassword; }
            }
          });
        }

      const stepTasks = (s?.tasks||[]);
      if(stepTasks.length){
        tasksWrap.style.display = '';
        tasksList.innerHTML='';
        stepTasks.forEach((t, i)=>{
          const id = slug((s.key||s.title)+'-'+(t.id||t));
          const row = document.createElement('label');
          row.className='row'; row.style.gap='12px'; row.style.alignItems='flex-start'; row.style.padding='6px 0';
          const text = (typeof t==='string')? t : (t.text||'');
          row.innerHTML = `<input type="checkbox" ${checked[id]? 'checked':''} style="margin-top:6px"/> <span>${text}</span>`;
          const box = row.querySelector('input');
          box.addEventListener('change', ()=>{
            setSaving();
            const wasChecked = !!checked[id];
            checked[id] = !!box.checked;
            // Trigger micro-pop only for this line's span
            if(!wasChecked && checked[id]){
              try{
                const labelSpan = row.querySelector('span');
                if(labelSpan){
                  labelSpan.classList.remove('pop');
                  void labelSpan.offsetWidth; // reflow to restart animation
                  labelSpan.classList.add('pop');
                  setTimeout(()=> labelSpan.classList.remove('pop'), 220);
                }
              }catch{}
            }
            // Lightweight UI updates to avoid re-rendering the whole step
            persist();
            updateProgress();
            try{
              const countEl = sidebar.querySelector('.step.active .count');
              if(countEl){
                const totalInStep = stepTasks.length;
                const doneInStep = stepTasks
                  .map(t => slug((s.key||s.title)+'-'+(t.id||t)))
                  .filter(tid => checked[tid]).length;
                countEl.textContent = totalInStep ? `${doneInStep}/${totalInStep}` : '';
              }
            }catch{}
            // Update final checklist only if it's present (last step)
            try{ renderFinalChecklist(); }catch{}
          });
          tasksList.appendChild(row);
        });
        // Stagger card indices for entrance animation
        [...stepBody.querySelectorAll('.kpi')].forEach((el, i)=> el.style.setProperty('--i', i));
        // Any change to tasks should reset inline Next confirmation state
        try{ resetNextConfirmMode(); }catch{}
      }else{
        tasksWrap.style.display = 'none';
        // If no tasks in this step, ensure confirm state is cleared
        try{ resetNextConfirmMode(); }catch{}
      }

      backBtn.disabled = current===0;
      // Last step: move Finish action to the global button row (outside shaded cards)
      const isLast = current===steps.length-1;
      if(isLast){
        try{ resetNextConfirmMode(); }catch{}
        // Show global Next button as "Finish"
        nextBtn.style.display = '';
        nextBtn.disabled = false;
        nextBtn.textContent = 'Finish';
        nextBtn.title = 'Finish Onboarding';
        nextBtn.onclick = (e)=>{ e.preventDefault(); try{ showClosingOverlay(); }catch(err){ console.error(err); } };
        // Remove in-card Finish button if present (keep Print inside card)
        const inCardFinish = document.getElementById('finishBtn');
        if(inCardFinish && inCardFinish.parentElement){ inCardFinish.remove(); }
        const printBtn = document.getElementById('finalPrintBtn');
        if(printBtn){
          printBtn.addEventListener('click', (e)=>{ e.preventDefault(); handlePrintWithSuggestedFilename(); });
        }
      }else{
        // Non-last steps: restore global Next button defaults
        nextBtn.style.display = '';
        nextBtn.disabled = false;
        nextBtn.textContent = 'Next';
        nextBtn.title = 'Next';
        nextBtn.onclick = null;
        // Clear any pending confirm state and inline message when rerendering non-last steps
        try{ resetNextConfirmMode(); }catch{}
      }
    }

    function renderFinalChecklist(){
      const list = document.getElementById('finalChecklist');
      if(!list) return;
      list.innerHTML='';
      const steps = visibleSteps();
      const items = [];
      steps.forEach(s=>{
        (s.tasks||[]).forEach(t=>{
          const id = slug((s.key||s.title)+'-'+(t.id||t));
          const text = (typeof t==='string') ? t : (t.text||'');
          items.push({ text, done: !!checked[id] });
        });
      });
      const unique = new Map();
      items.forEach(it=>{ if(!unique.has(it.text)) unique.set(it.text, it.done); else if(it.done) unique.set(it.text, true); });
      unique.forEach((done, text)=>{
        const li = document.createElement('li');
        li.className = done ? 'done' : 'todo';
        const color = done? '#10b981' : 'var(--border)';
        li.innerHTML = `<span style="display:inline-block; width:10px; height:10px; background:${color}; border-radius:50%; margin-right:8px"></span>${text}`;
        list.appendChild(li);
      });
    }

    function saveAndRender(rebuildSidebar=true){
      persist();
      updateProgress();
      renderMain();
      if(rebuildSidebar) renderSidebar();
      // Ensure the active class on sidebar reflects the current step even when only main is rerendered
        const stepButtons = sidebar.querySelectorAll('.step');
        stepButtons.forEach((b,i)=>{ b.classList.toggle('active', i===current); });
      // Keep the current step visible in the sidebar after any render
      scrollActiveStepIntoCenter();
      renderFinalChecklist();
    }

      function syncTitleWithRole(){
        const titleEl = stepBody.querySelector('[data-field="title"]');
        if(!titleEl) return;
        let desired = fields.title || (role==='lawyer' ? 'Lawyer' : 'Student-at-Law');
        if(role==='student') desired = 'Student-at-Law';
        // If current value differs or is empty, set it
        if(!fields.title || fields.title !== desired){
          fields.title = desired;
          titleEl.value = desired;
          persist();
        }
    }

    // Navigation
    backBtn.addEventListener('click', ()=>{ if(current>0){ setSaving(); current--; animateStepChange(); }});
    nextBtn.addEventListener('click', ()=>{
      if(current<visibleSteps().length-1){
        if(!validateStep(current)) return;
        // If there are outstanding tasks in this step, require confirmation before proceeding
        try{
          const steps = visibleSteps();
          const s = steps[current] || {};
          const stepTasks = (s.tasks||[]);
          if(stepTasks.length){
            const outstanding = stepTasks.filter(t=>{
              const id = slug((s.key||s.title)+'-'+(t.id||t));
              return !checked[id];
            });
            if(outstanding.length > 0 && nextBtn.dataset.confirm !== 'true'){
              const first = outstanding[0];
              const txt = (typeof first === 'string') ? first : (first && first.text) ? first.text : '';
              const safeTxt = escapeHtml(txt);
              const message = `There remains an outstanding task: "${safeTxt}". <br>Are you sure you want to continue to the next step?<br><br>If you faced a problem in completing this task, it will be addressed during the in-person onboarding session.`;
              enterNextConfirmMode(message);
              return;
            }
          }
        }catch{}
        setSaving();
        current++;
        if(current > furthestUnlocked){ furthestUnlocked = current; }
        // Clear confirm state when moving forward
        try{ resetNextConfirmMode(); }catch{}
        animateStepChange();
      }
    });

    function animateStepChange(){
      const content = document.querySelector('.content');
      if(!content){ saveAndRender(); return; }
      content.style.transition = 'opacity .25s ease, transform .25s ease';
      content.style.opacity = '0';
      content.style.transform = 'translateY(6px)';
      setTimeout(()=>{ saveAndRender(); content.style.opacity='1'; content.style.transform='translateY(0)'; }, 250);
    }

    function validateStep(index){
      const steps = visibleSteps();
      const s = steps[index];
      const titleSlug = slug(s.title);
      const req = stepRequirements[titleSlug] || {};
      let valid = true;
      // Clear previous errors
      const banner = document.getElementById('errorBanner');
      if(banner) banner.remove();
      document.querySelectorAll('#stepBody .field-error').forEach(el=> el.remove());
      // Inputs
      (req.requiredInputs||[]).forEach(key=>{
        const el = document.querySelector(`#stepBody [data-field="${key}"]`);
        if(!el || el.hasAttribute('readonly')) return;
        if(!el.value || el.value.trim()===''){
          valid = false;
          const msg = document.createElement('div');
          msg.className = 'field-error';
          msg.textContent = 'This field is required.';
          el.insertAdjacentElement('afterend', msg);
        }
      });
      if(!valid){ const content = document.querySelector('.content'); if(content){ content.classList.remove('shake'); void content.offsetWidth; content.classList.add('shake'); } }
      return valid;
    }

    // Role switching
    function setRole(r){
      if(role===r) return; role = r; setSaving();
      segs.forEach(el=>{ const on = el.getAttribute('data-role')===role; el.classList.toggle('active', on); el.setAttribute('aria-selected', on? 'true':'false'); });
      current = 0; furthestUnlocked = 0; saveAndRender();
      // If currently on Profile step after rerender, sync title field
      const currentTitle = (visibleSteps()[current]?.title||'').toLowerCase();
      if(currentTitle.includes('profile')){ syncTitleWithRole(); }
    }
    // role buttons removed

    // Reset & Print
      document.getElementById('resetBtn').addEventListener('click', ()=>{ checked = {}; fields = {}; current = 0; furthestUnlocked = 0; setSaving(); saveAndRender(); });
    // Final print button (in last step)
    // Keep a lightweight global listener as a fallback (explicit handlers are set on render)
    document.addEventListener('click', (e)=>{
      const el = e.target && e.target.closest ? e.target.closest('#finishBtn, #finalPrintBtn') : null;
      if(!el) return;
      e.preventDefault();
      if(el.id === 'finalPrintBtn'){ handlePrintWithSuggestedFilename(); }
      if(el.id === 'finishBtn'){
        try{ showClosingOverlay(); }catch(err){ console.error(err); }
      }
    });

    // Theme switching
    applyTheme();

    // Init
    saveAndRender();
    // Landing overlay behavior
    function startWithUniqueId(uid){
      if(!uid) return;
      if(String(uid).trim().toUpperCase()==='2539'){ showAdminConsole(); return; }
      const preset = getPresetForUniqueId(uid.toUpperCase());
      if(preset){
        fields.fullName = preset.fullName; fields.workEmail = preset.workEmail; fields.phoneExt = preset.phoneExt || fields.phoneExt; fields.title = preset.title || fields.title; fields.meetingLink = preset.meetingLink || fields.meetingLink; fields.uniqueId = uid.toUpperCase(); fields.__masterPassword = preset.password; persist(); saveAndRender();
        if(landingMsg){ landingMsg.innerHTML = `Welcome to the HCLS Member Network, ${preset.fullName}. Loading your onboarding package... <span class="spinner" aria-hidden="true"></span>`; }
        if(landing){
          // Ensure message is visible for full 5s before fade
          setTimeout(()=>{
            landing.classList.add('hidden');
            setTimeout(()=>{ landing.style.display='none'; }, 600);
          }, 5000);
        }
      }else{
        if(landingMsg) landingMsg.textContent = 'Unknown ID. Please try again.';
      }
    }
    if(landingApply){ landingApply.addEventListener('click', ()=> startWithUniqueId(landingUid?.value||'')); }
    if(landingUid){ landingUid.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ startWithUniqueId(landingUid.value||''); }}); }
    // If we already have a uniqueId (returning user), skip landing
    if(fields.uniqueId){ if(landing){ landing.style.display='none'; } }

    // (Parallax removed)
    function showClosingOverlay(){
      const overlay = document.createElement('div')
      overlay.className = 'landing fade-in closing-overlay';
      overlay.innerHTML = `
        <div class="panel" style="text-align:center; position:relative">
          <h1>Welcome to the Home Team Network</h1>
          <p style=\"margin:8px 0\">Next step: <a href=\"mailto:awol@hcls.law?subject=Self-Setup%20complete%20-%20Let%27s%20Meet!&body=Hello%20Alexander%2C%0A%0AI%27ve%20completed%20the%20self-setup%20guide%20and%20would%20like%20to%20schedule%20our%20in-person%20meeting.%20Please%20find%20attached%20a%20signed%20copy%20of%20the%20guide%20for%20reference.%0A%0ALet%20me%20know%20when%20you%27re%20available!\" style=\"color:#fff; text-decoration:underline; font-family: 'EB Garamond', serif\">Schedule a meeting</a> with Alexander W. Ostheimer-Lebeau for an in-person session (approx. 4 hours) to address any questions and to finalize the onboarding process.</p>
          <p style=\"margin:8px 0\">You've completed the self-setup process. You can now close this page.</p>


          </div>`;
      document.body.appendChild(overlay);
      // Floating Back button outside the tile
      const backBtn = document.createElement('button');
      backBtn.id = 'closingBackBtn';
      backBtn.className = 'btn-ghost';
      backBtn.textContent = 'Back';
      backBtn.style.position = 'fixed';
      backBtn.style.left = '16px';
      backBtn.style.bottom = '16px';
      backBtn.style.zIndex = '10000';
      overlay.appendChild(backBtn);
      requestAnimationFrame(()=>{ overlay.classList.add('show'); });
      backBtn.addEventListener('click', ()=>{
        overlay.classList.remove('show');
        setTimeout(()=>{ overlay.remove(); }, 300);
      });
    }

    function showAdminConsole(){
      const overlay = document.createElement('div');
      overlay.className = 'landing fade-in admin-overlay';
      const html = `
        <div class="panel">
          <h1 style="margin-bottom:4px">Admin Console</h1>
          <p style="margin-top:0">Manage Unique IDs used for auto-fill presets.</p>
          <div id="adminList" class="kpi" style="padding:16px; background:rgba(255,255,255,.06)"></div>
          <div class="row" style="gap:12px; margin-top:12px">
            <button class="btn-ghost" id="adminClose">Close</button>
            <button class="btn-brand" id="adminAdd">Add / Update</button>
          </div>
        </div>`;
      overlay.innerHTML = html;
      document.body.appendChild(overlay);
      requestAnimationFrame(()=> overlay.classList.add('show'));

      const listEl = overlay.querySelector('#adminList');

      function renderAdminRows(){
        const presets = loadPresets();
        const rows = Object.entries(presets).map(([id,p])=>{
          return `
          <div class="kpi" style="margin:12px 0; padding:12px; background:rgba(255,255,255,.04)">
            <div class="admin-entry" data-id="${id}" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:end">
              <div style="grid-column:1 / -1"><label style="font-size:12px">ID</label><input class="input" value="${id}" data-k="id"></div>
              <div style="grid-column:1 / -1"><label style="font-size:12px">Full name</label><input class="input" value="${p.fullName||''}" data-k="fullName"></div>
              <div style="grid-column:1 / -1"><label style="font-size:12px">Email</label><input class="input" value="${p.workEmail||''}" data-k="workEmail"></div>
              <div><label style="font-size:12px">Ext</label><input class="input" value="${p.phoneExt||''}" data-k="phoneExt"></div>
              <div><label style="font-size:12px">Title</label><input class="input" value="${p.title||''}" data-k="title"></div>
              <div style="grid-column:1 / -1"><label style="font-size:12px">Password</label><input class="input" value="${p.password||''}" data-k="password"></div>
              <div style="grid-column:1 / -1"><label style="font-size:12px">Meeting link</label><input class="input" value="${p.meetingLink||''}" data-k="meetingLink"></div>
              <div style="grid-column:1 / -1; display:flex; gap:8px; justify-content:flex-end">
                <button class="btn-ghost" data-action="save">Save</button>
                <button class="btn-ghost" data-action="delete">Delete</button>
              </div>
            </div>
          </div>`;
        }).join('');
        const addRow = `
          <div class="kpi" style="margin:12px 0; padding:12px; background:rgba(255,255,255,.04)">
            <div class="admin-entry" data-id="__new__" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:end">
              <div style="grid-column:1 / -1"><label style="font-size:12px">ID</label><input class="input" placeholder="NEWID" data-k="id"></div>
              <div style="grid-column:1 / -1"><label style="font-size:12px">Full name</label><input class="input" placeholder="Full name" data-k="fullName"></div>
              <div style="grid-column:1 / -1"><label style="font-size:12px">Email</label><input class="input" placeholder="email@hcls.law" data-k="workEmail"></div>
              <div><label style="font-size:12px">Ext</label><input class="input" placeholder="100" data-k="phoneExt"></div>
              <div><label style="font-size:12px">Title</label><input class="input" placeholder="Lawyer" data-k="title"></div>
              <div style="grid-column:1 / -1"><label style="font-size:12px">Password</label><input class="input" placeholder="PASSWORD" data-k="password"></div>
              <div style="grid-column:1 / -1"><label style="font-size:12px">Meeting link</label><input class="input" placeholder="https://calendly.com/your-link" data-k="meetingLink"></div>
            </div>
          </div>`;
        listEl.innerHTML = rows + addRow;
      }
      renderAdminRows();

      overlay.addEventListener('click', (e)=>{
        if(e.target && e.target.id === 'adminClose'){
          overlay.classList.remove('show');
          setTimeout(()=> overlay.remove(), 300);
          return;
        }
        if(e.target && e.target.id === 'adminAdd'){
          const container = overlay.querySelector('[data-id="__new__"]');
          const idVal = (container.querySelector('[data-k="id"]').value||'').trim().toUpperCase();
          if(!idVal) return;
          const p = {
            fullName: container.querySelector('[data-k="fullName"]').value.trim(),
            workEmail: container.querySelector('[data-k="workEmail"]').value.trim(),
            phoneExt: container.querySelector('[data-k="phoneExt"]').value.trim(),
            title: container.querySelector('[data-k="title"]').value.trim(),
            password: container.querySelector('[data-k="password"]').value.trim(),
            meetingLink: container.querySelector('[data-k="meetingLink"]').value.trim()
          };
          const presets = loadPresets();
          presets[idVal] = p; savePresets(presets); renderAdminRows();
          return;
        }
        const saveBtn = e.target && e.target.closest && e.target.closest('[data-action="save"]');
        if(saveBtn){
          const row = saveBtn.closest('[data-id]');
          const idVal = row.querySelector('[data-k="id"]').value.trim().toUpperCase();
          const updated = {
            fullName: row.querySelector('[data-k="fullName"]').value.trim(),
            workEmail: row.querySelector('[data-k="workEmail"]').value.trim(),
            phoneExt: row.querySelector('[data-k="phoneExt"]').value.trim(),
            title: row.querySelector('[data-k="title"]').value.trim(),
            password: row.querySelector('[data-k="password"]').value.trim(),
            meetingLink: row.querySelector('[data-k="meetingLink"]').value.trim()
          };
          const presets = loadPresets();
          presets[idVal] = updated; savePresets(presets); renderAdminRows();
          return;
        }
        const delBtn = e.target && e.target.closest && e.target.closest('[data-action="delete"]');
        if(delBtn){
          const row = delBtn.closest('[data-id]');
          const idVal = row.getAttribute('data-id');
          const presets = loadPresets();
          delete presets[idVal]; savePresets(presets); renderAdminRows();
        }
      });
    }

    function formatDateForFilename(){
      const now = new Date();
      const pad = (n)=> String(n).padStart(2, '0');
      const yyyy = now.getFullYear();
      const mm = pad(now.getMonth() + 1);
      const dd = pad(now.getDate());
      return `${yyyy}-${mm}-${dd}`;
    }

    function getLastFirstFromName(full){
      const raw = String(full||'').trim();
      if(!raw){ return 'Member'; }
      const parts = raw.split(/\s+/).filter(Boolean);
      if(parts.length === 1){
        return `${parts[0]}`;
      }
      const first = parts[0];
      const last = parts[parts.length - 1];
      return `${last}_${first}`;
    }

    function sanitizeForFilename(name){
      return String(name||'').replace(/[\\/:*?"<>|]+/g, '').replace(/\s+/g, ' ').trim();
    }

    function buildSuggestedFilename(){
      const dateStr = formatDateForFilename();
      const displayName = fields.confirmName || fields.fullName || 'Member';
      const lastFirst = getLastFirstFromName(displayName);
      const base = `${dateStr} - ${lastFirst} - Onboarding Guide - Complete`;
      return sanitizeForFilename(base);
    }

    function handlePrintWithSuggestedFilename(){
      const previousTitle = document.title;
      const suggested = buildSuggestedFilename();
      document.title = suggested;
      const restore = ()=>{ document.title = previousTitle; };
      const restoreOnce = ()=>{ window.removeEventListener('afterprint', restoreOnce); restore(); };
      try{ window.addEventListener('afterprint', restoreOnce, { once:true }); }catch{}
      // Force full render of final checklist before printing
      try{ renderFinalChecklist(); }catch{}
      // Give the browser a tick to paint any pending layout before print
      requestAnimationFrame(()=>{
        setTimeout(()=>{ try{ window.print(); }finally{ setTimeout(restore, 1000); } }, 50);
      });
    }
  })();
  </script>
</body>
</html>
